const It="notion-active-user-id";function gt(e){return new Promise((t,n)=>{e(t)})}function ht(e,t){return new Promise((n,a)=>{e(t,n)})}class mo{constructor(t=1){this.running=0,this.taskQueue=[],this._resolve=null,this.concurrency=t}async _checkDone(){this._resolve&&this.running==0&&this.taskQueue.length==0&&(this._resolve(),this._resolve=null)}async _runTask(t){this.running++;try{await t()}catch{}this.running--,this.taskQueue.length>0&&this._runTask(this.taskQueue.shift()),this._checkDone()}_enqueueTask(t){this.taskQueue.push(t)}push(t){this.running<this.concurrency?this._runTask(t):this._enqueueTask(t)}async totallyEmpty(){return new Promise(t=>{if(this._resolve)throw"error queue only one";this._resolve=t,this._checkDone()})}}function yo(e){for(var t=atob(e.split(",")[1]),n=[],a=0;a<t.length;a++)n.push(t.charCodeAt(a));return new Blob([new Uint8Array(n)],{type:"image/jpeg"})}function Yt(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*a));return t}const ne=(...e)=>{},Ne=async e=>new Promise(t=>setTimeout(t,e));function ue(e){let t=typeof e=="string"?new Date(e):e;var n=new Date(t.getTime()),a=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1).padStart(2,"0"),o=n.getFullYear();return o+"-"+i+"-"+a}const te=(e,...t)=>{const n={};let a;for(a in e)t.includes(a)||(n[a]=e[a]);return n};function wo(e,...t){const n={};for(const a of t)a in e&&(n[a]=e[a]);return n}function Dt(e){return e&&typeof e=="object"&&!Array.isArray(e)}function ft(e,...t){if(!t.length)return e;const n=t.shift();if(Dt(e)&&Dt(n))for(const a in n)Dt(n[a])?(e[a]||Object.assign(e,{[a]:{}}),ft(e[a],n[a])):Object.assign(e,{[a]:n[a]});return ft(e,...t)}function pa(e){return e.reduce((t,n)=>ft(t,n),{})}function bo(e){return e==null}async function ae(){return new Promise((e,t)=>{try{chrome.tabs.query({currentWindow:!0,active:!0},function(n){e(n[0])})}catch(n){t(n)}})}async function oe(e,t,n){const a=n||(await ae()).id;return new Promise(i=>{chrome.tabs.sendMessage(a,{event:e,props:t,destination:"content",v2:!0},o=>{i(o)})})}async function _o(e,t,{tabId:n,frameId:a}){const i=n;return new Promise(o=>{chrome.tabs.sendMessage(i,{event:e,props:t,destination:"iframe",v2:!0},{frameId:a},s=>{o(s)})})}function kt(){return`${chrome.runtime.id.replace(/[\W_]+/g,"")}`}var lt,ia,oa,ke=((oa=(ia=(lt=chrome.runtime)==null?void 0:lt.getManifest)==null?void 0:ia.call(lt))==null?void 0:oa.description.includes("Firefox"))??!1;const ga=ke;function vo(e){const t=n(e);Object.keys(t).forEach(a=>{window[a]=t[a]});function n(a){return Object.keys(a).reduce((i,o)=>(i[o]=a[o]==="__null__"?null:a[o],i),{})}}function Io(e){return Object.keys(e).reduce((t,n)=>(t[n]=e[n]===null?"__null__":e[n],t),{})}async function re(e,t){const n=t||(await ae()).id;return new Promise(async a=>{const i=await Ct({target:{tabId:n},func:vo,args:[Io(e)]});a(i)})}async function ko(e,t){return new Promise(n=>{Ct({target:{tabId:t},func:a=>window[a]!==void 0,args:[e]})})}async function Xt(e,{file:t,params:n},a){return n&&await re(n,e),new Promise(async i=>{let s=(await Ct({target:{tabId:e},files:[t]})).map(c=>c.result);i(s),a(s)})}async function Ce(e,t){const n=t||await ae();return await new Promise(a=>Xt(n.id,{file:`/${e}`},i=>{a(i==null?void 0:i[0])}))}async function Ee(e,t){return await new Promise(n=>Xt(t,{file:`/${e}`},a=>{n(a==null?void 0:a[0])}))}async function Co({filename:e,tabId:t,frameId:n}){let i=(await Ct({target:{tabId:t,frameIds:[n]},files:[e]})).map(o=>o.result);return i==null?void 0:i[0]}async function So(e,t){return await re(e,t),Ee("clipper.js",t)}async function To(e,t){return Ee("content/content.js",t)}async function Po(e,t){return await re(e,t),Ee("clipContent.js",t)}async function xo(e,t,n,a){var s;const i=a??((s=await ae())==null?void 0:s.id),o=Math.floor((1+Math.random())*65536).toString(16).substring(1);return await new Promise(async c=>{await re({idName:kt(),asyncId:o,...n??{}},i),fe[o]=async u=>{const d=await t(u);return d&&(c(d),delete fe[o]),d},await Ee(e,i)})}async function Zt(e,t,n,a){var s;const i=a??((s=await ae())==null?void 0:s.id),o=Math.floor((1+Math.random())*65536).toString(16).substring(1);return await new Promise(async c=>{await re({idName:kt(),asyncId:o,extraParamsJson:n?JSON.stringify(n):null},i),fe[o]=async u=>{const d=await t(u);return d&&(c(d),delete fe[o]),d},await Ee(e,i)})}const Ct=async e=>{if(!ga)return chrome.scripting.executeScript(e);const t=e.target.tabId;if(e.func){const a=e.args||[],o=`(${e.func.toString()})(${a.map(s=>JSON.stringify(s)).join(",")})`;return await new Promise(s=>{chrome.tabs.executeScript(t,{code:o},c=>s(n(c)))})}else if(e.files){const a=e.files[0];return await new Promise(i=>{chrome.tabs.executeScript(t,{file:a},o=>i(n(o)))})}throw new Error("not implemented");function n(a){return a?a.map(o=>({result:o,frameId:0})):[]}};async function en(e){let t;try{t=e??await ae()}catch{return}let n=await new Promise(a=>Xt(t.id,{file:"/parseMetaTags.js"},i=>{a(i[0])}));return{...n,url:t.url,originUrl:t.url,favIconUrl:t.favIconUrl,icon:n.icon??t.favIconUrl,...Eo(n,t)}}function Eo(e,t){const a=new URL(t.url).hostname.replace(/^www\./,"");return a in $n?Object.entries($n[a]||{}).reduce((i,[o,s])=>(typeof s=="string"?i[o]=s:i[o]=s(e,t),i),{}):{}}const $n={"mail.google.com":{icon:"https://upload.wikimedia.org/wikipedia/commons/7/7e/Gmail_icon_%282020%29.svg"},"youtube.com":{title:(e,t)=>{var n;return((n=e.yt_author)==null?void 0:n.length)&&`${t.title||""} - ${e.yt_author}`||t.title},icon:"https://upload.wikimedia.org/wikipedia/commons/0/09/YouTube_full-color_icon_%282017%29.svg"},"x.com":{title:(e,t)=>e.description?`${e.title.replace(/ on X$/,"").trim()} ${e.description}`:e.title}};function ha(e){return chrome.runtime.getURL("popup/index.html")}async function Pe(e,t,n,a){const i=kt();So({idName:i,popupUrl:ha(),anchor:n?{x:n.x,y:n.y}:null,integration:a||null,action:e},t)}function fa(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}const ve=0,Ie=-1,ee={verbose:2,debug:3,info:4,warn:5,error:6},Uo=ee.warn,Z={fgBlack:"\x1B[30m",fgRed:"\x1B[31m",fgGreen:"\x1B[32m",fgYellow:"\x1B[33m",fgBlue:"\x1B[34m",fgPink:"\x1B[35m",fgCyan:"\x1B[36m",fgWhite:"\x1B[37m",reset:"\x1B[0m",bold:"\x1B[1m"};class Oo{constructor(t,n={}){this.appName=t,this.useColor=typeof n.useColor>"u"?!0:n.useColor,this.setLogLevel(n.logLevel)}verbose(){if(ee.verbose>=this.logLevel){let t=Array.from(arguments);return t.unshift(this._makeHeader("V",Z.bold+Z.fgBlue)),console.error.apply(console,t),ve}else return Ie}debug(){if(ee.debug>=this.logLevel){let t=Array.from(arguments);return t.unshift(this._makeHeader("D",Z.bold+Z.fgBlue)),console.log.apply(console,t),ve}else return Ie}info(){if(ee.info>=this.logLevel){let t=Array.from(arguments);return t.unshift(this._makeHeader("I",Z.bold+Z.fgGreen)),console.log.apply(console,t),ve}else return Ie}warn(){if(ee.warn>=this.logLevel){let t=Array.from(arguments);return t.unshift(this._makeHeader("W",Z.bold+Z.fgYellow)),console.log.apply(console,t),ve}else return Ie}error(){if(ee.error>=this.logLevel){let t=Array.from(arguments);return t.unshift(this._makeHeader("E",Z.bold+Z.fgRed)),console.error.apply(console,t),ve}else return Ie}setLogLevel(t){switch(t){case"verbose":this.logLevel=ee.verbose;break;case"debug":this.logLevel=ee.debug;break;case"info":this.logLevel=ee.info;break;case"warn":this.logLevel=ee.warn;break;case"error":this.logLevel=ee.error;break;default:return this.warn(`Unknown log level string: ${t}, please specify one of verbose, debug, info, warn, error.`),this.logLevel=Uo,Ie}return ve}_makeHeader(t,n){const a=`${t}/${this.appName}(${Ao()}):`;return this.useColor&&n?n+a+Z.reset:a}}function Ao(){let t=new Date().getTimezoneOffset()*6e4,n=Date.now()-t;return new Date(n).toISOString().replace(/Z|-|:/g,"")}var Mo={Logger:Oo,RET_FAIL:Ie,RET_SUCCESS:ve};const ma=new Mo.Logger("notionapi-agent");class tn extends Error{constructor(t){super(),this.name="RequestError",Object.setPrototypeOf(this,tn.prototype),this.message=t}}function jo(e){const t=new URL(e);if(t.protocol!=="http:"&&t.protocol!=="https:")throw new tn(`Unsupported protocol: ${t.protocol}`);const n=t.port?t.port:t.protocol==="http:"?80:443,a={hostname:t.hostname,authority:t.hostname,port:n,path:t.pathname+t.search,method:"POST",headers:{}};return{setHeader:function(i,o){return a.headers[i]=o,this},sendAsJson:async function(i){ma.debug(`http-util.ts: ${a.method} ${a.hostname} ${a.port} ${a.path}`),this.setHeader("accept-encoding","gzip, deflate"),this.setHeader("content-type","application/json");let o="";try{i&&(o=JSON.stringify(i))}catch(c){throw c}let s;try{s=await fetch(t.toString(),{method:"post",headers:a.headers,body:o})}catch(c){throw c}try{return await s.json()}catch(c){throw c}}}}const Fe={server:"https://www.notion.so",userAgent:"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36"};class nn extends Error{constructor(t){super(),this.name="APIError",Object.setPrototypeOf(this,nn.prototype),this.message=`Server says "${t.name}: ${t.message}`,t.status&&(this.message+=` Status: ${t.status}`),this.message+='"'}}class Fo{constructor(t={}){this.server=Fe.server,this.token=t.token?t.token:null,this.server=t.server?t.server:Fe.server,t.activeUserId&&(this.activeUserId=t.activeUserId)}async _post(t,n){ma.debug(`agent.ts: Call API "${t}".`);const a=jo(`${this.server}${t.startsWith("/")?"":"/"}${t}`).setHeader("accept","*/*").setHeader("accept-language","en-US,en;q=0.9").setHeader("origin",Fe.server).setHeader("referer",Fe.server).setHeader("user-agent",Fe.userAgent);this.token&&a.setHeader("cookie",`token_v2=${this.token};`),this.activeUserId&&a.setHeader("x-notion-active-user-header",this.activeUserId);const i=await a.sendAsJson(n);if(i.hasOwnProperty("errorId")){const o=i;throw new nn(o)}return i}getActivityLog(t){return this._post("/api/v3/getActivityLog",t)}getAssetsJson(t){return this._post("/api/v3/getAssetsJson",t)}getRecordValues(t){return this._post("/api/v3/getRecordValues",t)}getSnapshotsList(t){return this._post("/api/v3/getSnapshotsList",t)}getUserSharedPages(t){return this._post("/api/v3/getUserSharedPages",t)}loadPageChunk(t){return this._post("/api/v3/loadPageChunk",t)}loadUserContent(t){return this._post("/api/v3/loadUserContent",t)}queryCollection(t){return this._post("/api/v3/queryCollection",t)}submitTransaction(t){return this._post("/api/v3/submitTransaction",t)}search(t){return this._post("/api/v3/search",t)}}function $o(e={}){return new Fo(e)}const Do=async e=>new Promise(t=>setTimeout(t,e));let xe=0;const De=(e="",...t)=>{ne(`${" ".repeat(xe*4)}${e}`,...t)},Bo=(e="",...t)=>{ne(`${" ".repeat(xe*4)}${e}`,...t)},Lo=(e="",...t)=>{ne(`${" ".repeat(xe*4)}${e}`,...t)},No=e=>{De(`${e}…`),xe+=1;let t=!1;return{_startingTime:Date.now(),_getDiffTime(){return Date.now()-this._startingTime},_getDiffTimeStr(){const n=this._getDiffTime()/1e3;return n<.1?"":` (+${n.toFixed(2)}s)`},done(n="",...a){if(t)throw new Error("You can't call done() twice");Lo(n+this._getDiffTimeStr(),...a),xe-=1,t=!0},error(n=""){if(t)throw new Error("You can't call done() twice");Bo(n+this._getDiffTimeStr()),xe-=1,t=!0}}};async function Wo(e,t){const n=No(`'${e}' started`);try{const a=await t();return n.done(`'${e}' successfully completed`),a}catch(a){throw n.done(`'${e}' failed to complete`),a}}class Ro extends Error{constructor(){super(...arguments),this.helpMsg=null}}var F=(e=>(e.bullet="bullet",e.code="code",e.quote="quote",e.toggle="toggle",e))(F||{}),We=(e=>(e.extractFullPage="extractFullPage",e.bookmark="bookmark",e))(We||{}),ya=(e=>(e.noClip="noClip",e.defaultClip="defaultClip",e.selectZone="selectZone",e.clipTweet="clipTweet",e.clipYoutubeVideo="clipYoutubeVideo",e.clipTwitterThread="clipTwitterThread",e.clipMail="clipMail",e.clipMailConversation="clipMailConversation",e))(ya||{});const Ve={highlightAsBulletPoint:!1,showPremiumFeatures:!1,supportGmailIntegration:!1,highlightFormat:F==null?void 0:F.bullet,openDesktopUrl:!1};function mt(e,t){return t===0?e:e+"_"+t}var ra,sa;const Dn=((sa=(ra=chrome.storage)==null?void 0:ra.sync)==null?void 0:sa.QUOTA_BYTES_PER_ITEM)||8192;var ca,la;const an=((la=(ca=chrome.storage)==null?void 0:ca.sync)==null?void 0:la.MAX_ITEMS)||512;function Ho(e,t,n){var a=0,i={},o,s;let c=JSON.stringify(t),u=[];for(;c.length>0;)s=mt(e,a),o=c.substr(0,Dn-s.length-2),u.push(o.length),i[s]=o,c=c.substr(Dn-s.length-2),a++;chrome.storage.local.set(i,n),chrome.storage.local.remove(mt(e,a))}async function wa(e){return new Promise(t=>{chrome.storage.local.get([e],function(n){t(n[e])})})}function zo(e,t,n){chrome.storage.local.get([e,`${e}_1`],async function(a){let i;if(a[`${e}_1`]!=null){for(let o=2;o<an&&(a[`${e}_${o}`]=await wa(`${e}_${o}`),a[`${e}_${o}`]!==void 0);o++);i=_a(e,a)}else i=a[e]!==void 0?ba(a[e]):void 0;i!==void 0?t(i):n()})}function ba(e){try{return JSON.parse(e)}catch{return}}function _a(e,t){var n,a="";let i=!1;for(n=0;n<an&&t[mt(e,n)]!==void 0;n++)i=!0,a+=t[mt(e,n)];if(i)return ba(a)}function Vo(e,t){chrome.storage.local.get([e,`${e}_1`],async function(n){var a=[];if(n[e]!=null&&a.push(e),n[`${e}_1`]!=null){a.push(`${e}_1`);for(let i=2;i<an&&(n[`${e}_${i}`]=await wa(`${e}_${i}`),n[`${e}_${i}`]!==void 0);i++)a.push(`${e}_${i}`)}chrome.storage.local.remove(a,()=>{t()})})}async function va(e,t){return new Promise(n=>{zo(e,a=>{n(a)},async()=>{await on(e,t),n(t)})})}async function Ia(e){return new Promise(t=>{chrome.storage.local.get(null,function(n){const a=Object.keys(n).filter(i=>qo(i)&&e.test(i)).map(i=>[i,_a(i,n)]).filter(([i,o])=>!bo(o));t(Object.fromEntries(a))})})}function qo(e){return/.*_\d+$/g.test(e)===!1}async function on(e,t=null){new Promise(n=>{Ho(e,t,()=>{n()})})}async function ka(e){new Promise(t=>{Vo(e,()=>{t()})})}const J={set:on,get:va,getAll:Ia,remove:ka,syncSet:async(e,t=null)=>null};function x(e,t,n=J){return{type:"crud",_t:t,get:a=>n.get(`data-${e}-${a}`,t),save:async(a,i,o)=>(await n.set(`data-${e}-${a}`,i,!(o!=null&&o.noSync)),i),remove:async a=>{await n.remove(`data-${e}-${a}`)},delete:async a=>{await n.remove(`data-${e}-${a}`)},all:async()=>Object.fromEntries(Object.entries(await n.getAll(new RegExp(`^data-${e}.*$`))).map(([a,i])=>[a.replace(`data-${e}-`,""),i])),syncSet:async a=>{const i=await n.get(`data-${e}-${a}`,t);await n.syncSet(`data-${e}-${a}`,i,!0)}}}function M(e,t,n=J,a){return{type:"single",_t:t,load:()=>n.get(`data-${e}`,t),save:async(i,o)=>{const c={...await n.get(`data-${e}`,t),...i};return await n.set(`data-${e}`,c,o!=null&&o.noSync?!1:u()),c;function u(){return a&&Object.keys(i).some(d=>a.includes(d))}},remove:async()=>{await n.remove(`data-${e}`)},syncSave:async()=>{const i=await n.get(`data-${e}`,t);await n.syncSet(`data-${e}`,i,!0)}}}let yt=null;async function Go(e){return Object.fromEntries(await Promise.all(Object.keys(e).map(async t=>{const n=await(e[t].type=="crud"?e[t].all():e[t].load());return[t,n]})))}async function Ko(e,t){const n=Object.keys(e).flatMap(a=>e[a].type=="crud"?Object.keys(t[a]??[]).map(i=>e[a].save(i,t[a][i])):[e[a].save(t[a])]);return await Promise.all(n),t}async function Qo({oldDatabase:e,newDatabase:t,migration:n}){De("migration step 1 - load data");const a=await Go(e);De("migration step 2 - run migration code");const i=await n.up(a,J);De("migration step 3 - remove old storage keys",i),await Promise.all(n.storageKeysToRemove.map(o=>J.remove(o))),De("migration step 4 - add data to database",i),await Ko(t,i)}async function Jo(){if(!(yt.migration>=$e.length))for(let e=yt.migration;e<$e.length;e++)await Wo(`run migration ${e}`,async()=>{var t;await Qo({oldDatabase:((t=$e[e-1])==null?void 0:t.db)||{},newDatabase:$e[e].db,migration:$e[e].migration})}),await J.set("rootConfig",{migration:e+1})}function Yo(e){return async(...t)=>(yt||(yt=await J.get("rootConfig",{migration:0}),await Jo()),e(...t))}function Xo(e){let t={};return Object.entries(e).forEach(([n,a])=>{t[n]=Object.fromEntries(Object.entries(a).map(([i,o])=>[i,i==="_t"||i==="type"?o:Yo(o)]))}),t}const Zo={user:M("user",{forms:[],settings:Ve}),form:x("forms",null),notionCollection:x("notionCollections")},Bn="STORAGE_KEY_FORM_LIST",Ln="form-",er={storageKeysToRemove:["FORM_LIST_KEY"],async up(e,t){var s,c,u;const n=await t.get(Bn,[]);this.storageKeysToRemove.push(Bn);const a={forms:n.map(d=>({id:d.id,name:d.name,favorite:d.favorite,isFolder:d.isFolder??!1,parentFolderId:d.parentFolderId}))},i={},o={};for(let d of n){const p=await t.get(Ln+d.id,null);p&&(p.collection&&(i[(s=p.collection)==null?void 0:s.id]=p.collection),o[p.id]={id:p.id,name:p.name,fields:p.daps,favorite:d.favorite,parentFolderId:d.parentFolderId,notionCollectionId:(c=p.collection)==null?void 0:c.id,notionParentCollectionId:(u=p.collection)==null?void 0:u.parent_id,spaceId:p.spaceId,userId:p.userId,template:p.template,savePageContent:p.savePageContent,needToRefreshTemplate:p.needToRefreshTemplate},this.storageKeysToRemove.push(Ln+d.id))}return{user:a,form:o,notionCollection:i}}},tr={highlightAsBulletPoint:!1,showPremiumFeatures:!1,supportGmailIntegration:!1,highlightFormat:F.bullet,openDesktopUrl:!1},nr={storageKeysToRemove:["settings","open-desktop"],up:async(e,t)=>{const n=Object.fromEntries(Object.entries(e.form).map(([s,c])=>{const u=e.notionCollection[c.notionCollectionId],d=ar(c.name)??(u==null?void 0:u.icon)??null,p=ir(c.name);return d?[s,{...c,name:p,icon:d}]:[s,c]})),a=await t.get("settings",tr),i=await t.get("open-desktop",!1),o={...e.user,forms:e.user.forms.map(s=>({...s,...wo(n[s.id]||{},"icon","name","notionCollectionId","notionParentCollectionId")})),settings:{...a,...i&&{openDesktopUrl:i}}};return{...e,form:n,user:o}}};function ar(e){var t,n;return(n=(t=/^\s*\p{Emoji}/u.exec(e))==null?void 0:t[0])==null?void 0:n.trim()}function ir(e){return e.replace(/^\s*\p{Emoji}/u,"").trim()}const or={user:M("user",{forms:[]}),form:x("forms",null),notionCollection:x("notionCollections")},rr={user:M("user",{forms:[],settings:Ve,capturedWebpages:[]}),form:x("forms",null),notionCollection:x("notionCollections"),capturedWebpage:x("capturedWebpage",null),highlight:x("highlight",null)},sr={storageKeysToRemove:[],up:async(e,t)=>({...e,user:{...e.user,capturedWebpages:[]},capturedWebpage:{},highlight:{}})},cr={user:M("user",{forms:[],settings:Ve,capturedWebpages:[]}),form:x("forms",null),notionCollection:x("notionCollections"),capturedWebpage:x("capturedWebpage",null),highlight:x("highlight",null)};function lr(e=4){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*a));return t}const ur={storageKeysToRemove:[],up:async(e,t)=>({...e,form:Object.fromEntries(Object.entries(e.form).map(([n,a])=>[n,te({...a,fields:[...a.fields.map(i=>te(i,"kind")),...a.template?[{key:lr(6),property:{name:"Template",type:"template",id:"template"},options:{defaultValue:a.template},fieldOptions:{locked:!0}}]:[]]},"template")]))})},dr={user:M("user",{forms:[],settings:Ve,capturedWebpages:[]}),form:x("forms",null),notionCollection:x("notionCollections"),capturedWebpage:x("capturedWebpage",null),urlToCapturedWebpage:x("urlToCapturedWebpage",null),highlight:x("highlight",null),notionSync:M("notionSync",{pendingEvents:[],failedEvents:[]})},pr={storageKeysToRemove:[],async up(e,t){const n=await t.getAll(/page-.*/),a={};let i=[];const o={},s={};for(let[c,u]of Object.entries(n)){this.storageKeysToRemove.push(c);const d=Yt(10);let p=[];a[d]={url:u.url,id:d,clipFormat:We.bookmark,title:null,notionCollectionId:null,notionSpaceId:null,icon:null,highlights:p,formId:null,notionPageId:u.notionPageId,notionListAfterId:u.notionListAfterId,createdAt:u.createdAt},i.push(d),s[u.url]={capturedWebpageId:d,url:u.url}}return{...e,user:{...e.user,capturedWebpages:i},notionSync:{pendingEvents:[],failedEvents:[]},urlToCapturedWebpage:s,capturedWebpage:a,highlight:o}}};var rt,gr=new Uint8Array(16);function hr(){if(!rt&&(rt=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!rt))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return rt(gr)}const fr=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function mr(e){return typeof e=="string"&&fr.test(e)}var N=[];for(var Bt=0;Bt<256;++Bt)N.push((Bt+256).toString(16).substr(1));function yr(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(N[e[t+0]]+N[e[t+1]]+N[e[t+2]]+N[e[t+3]]+"-"+N[e[t+4]]+N[e[t+5]]+"-"+N[e[t+6]]+N[e[t+7]]+"-"+N[e[t+8]]+N[e[t+9]]+"-"+N[e[t+10]]+N[e[t+11]]+N[e[t+12]]+N[e[t+13]]+N[e[t+14]]+N[e[t+15]]).toLowerCase();if(!mr(n))throw TypeError("Stringified UUID is invalid");return n}function R(e,t,n){e=e||{};var a=e.random||(e.rng||hr)();if(a[6]=a[6]&15|64,a[8]=a[8]&63|128,t){n=n||0;for(var i=0;i<16;++i)t[n+i]=a[i];return t}return yr(a)}async function Nn(e){const t=await e.text();try{return JSON.parse(t)}catch{return t}}async function wr(e,{}){var a,i,o,s,c;let t;try{t=await fetch(e.url,e.props)}catch(u){return console.error(u),((a=u==null?void 0:u.response)==null?void 0:a.status)==401?{success:!1,error:{code:"Unauthorized",message:"Unauthorized"}}:{success:!1,error:{code:"NETWORK_ERROR",message:"Network error"}}}if(t.status>299){const u=await Nn(t);return{success:!1,error:typeof u=="string"?{message:u}:u}}const n=await Nn(t);if(typeof n=="string")return{success:!0,data:n};if("success"in n&&!n.success){if(console.error(n),typeof n.error=="string")return{success:!1,error:{message:n.error}};if(!((i=n.error)!=null&&i.message))return{success:!1,error:{code:((o=n.error)==null?void 0:o.code)||"UnknownError",message:((s=n.error)==null?void 0:s.code)&&`error (${(c=n.error)==null?void 0:c.code})`||"something went wrong"}}}return n}const br=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Lt=e=>{const t=new Date(e),n=t.getMonth();return`${br[n]} ${t.getDate()}, ${t.getFullYear()}`};function _r(e){let t;switch(e.type){case"datetime":case"date":return t=e.start_date,Lt(t);case"daterange":case"datetimerange":t=e.start_date;const n=e.end_date;return`${Lt(t)} → ${Lt(n)}`;default:return null}}function Re(e,t,n){if(typeof(e==null?void 0:e[t])=="string")return e[t];if(!(e!=null&&e[t]!=null&&Array.isArray(e[t])&&e[t].every(i=>Array.isArray(i))))return n;let a="";return e[t].forEach(([i,o])=>{if(!o){a+=i;return}const s=o.flatMap(c=>{switch(c[0]){case"d":const u=c[1];return[_r(u)];default:return[]}});s.length&&(a+=s.join(" "))}),a}async function vr(e,{notionClient:t}){var i,o;let n=await t.search({type:"BlocksInCollection",query:e.text,spaceId:e.spaceId,collectionId:e.collectionId,limit:20,filters:{isDeletedOnly:!1,excludeTemplates:!0,navigableBlockContentOnly:!0,requireEditPermissions:!1,includePublicPagesWithoutExplicitAccess:!0,ancestors:[],createdBy:[],editedBy:[],lastEditedTime:{},createdTime:{},inTeams:[]},sort:{field:"relevance"},source:"relation_menu",recentPagesForBoosting:[],ignoresHighlight:!0}),a=[];for(let s of n.results){let c=s.id;if(!(c in n.recordMap.block))continue;let u=n.recordMap.block[c].value;u.is_template||a.push({id:u.id,name:Re(u.properties,"title","Untitled"),title:(i=u.properties)==null?void 0:i.title,icon:((o=u.format)==null?void 0:o.page_icon)||null})}return a}async function Ca(e,{notionClient:t}){try{await t.submitOperations([{pointer:{table:"collection",id:e.collectionId,spaceId:e.spaceId},command:"keyedObjectListUpdate",path:["schema",e.propertyId,"options"],args:{value:e.option}}],e.spaceId)}catch(n){return console.error(n),{success:!1}}return{success:!0}}async function Ir(e,t){return Ca(e,t)}async function kr(e,{notionClient:t}){var n;try{await t.submitOperations([(n=e.pos)!=null&&n.beforeId?{pointer:{table:"collection",id:e.collectionId,spaceId:e.spaceId},command:"keyedObjectListBefore",path:["schema",e.propertyId,"options"],args:{value:e.option,before:{id:e.pos.beforeId}}}:{pointer:{table:"collection",id:e.collectionId,spaceId:e.spaceId},command:"keyedObjectListAfter",path:["schema",e.propertyId,"options"],args:{value:e.option}}],e.spaceId)}catch(a){return console.error(a),{success:!1}}return{success:!0}}async function Cr(e,{notionClient:t}){try{return{success:!0,page:(await t.custom.getPage({pageId:e.pageId})).value}}catch(n){return console.error(n),{success:!1}}}async function Sr(e,{notionClient:t}){try{return{success:!0,collection:(await t.custom.getCollection({pageId:e.pageId,parentCollectionId:null,collectionId:e.collectionId})).value}}catch(n){return console.error(n),{success:!1}}}function Tr(e){return new TextDecoder().decode(e)}const rn=Tr(new Uint8Array([226,128,163])),Pr=(e,t)=>{switch(t.type){case"checkbox":if(typeof e!="boolean")throw`value passed to property ${t.strippedName} must be bool`;return[[e?"Yes":"No"]];case"file":if(e.length==0)return null;let n=[];return(e??[]).forEach((i,o)=>{let s=ls(i.imgUrl).trim();n.push([`${s.length?s:"file"}`,[["a",i.imgUrl]]]),o+1<e.length&&n.push([","])}),n;case"date":if(e==null)return[];const a=Array.isArray(e)?{type:"daterange",start_date:ue(e[0]),end_date:ue(e[1])}:{type:"date",start_date:ue(e)};return[[rn,[["d",a]]]];case"url":case"select":case"status":case"text":case"title":return[[e??""]];case"number":return(t==null?void 0:t.number_format)=="percent"?[[String(parseFloat(e)/100)]]:[[String(parseFloat(e))]];case"multi_select":return[[e.join(",")]];case"person":case"relation":return e;default:return ne(`WARNING: ${t.type} not uncasted`),[[e]]}};function Wn(e,t){const n={relation:"p",person:"u"};let a=e||[],i=[];return a.forEach((o,s)=>{i.push([rn,[[n[t],o]]]),s+1<a.length&&i.push([","])}),i}async function xr(e,{notionClient:t}){try{const n=await t.saveOperations(Er(e),e.spaceId);return{success:!0}}catch(n){return console.error(n),{success:!1}}}function Er(e){return[...Object.entries(e.notionPageUpdatedObject.format||{}).map(([t,n])=>Or({value:n,propertyId:t,pageId:e.pageId,spaceId:e.spaceId})),...Object.entries(e.notionPageUpdatedObject.properties||{}).map(([t,n])=>Ar({value:n,pageId:e.pageId,property:e.schema[t],propertyId:t,spaceId:e.spaceId})),Ur({spaceId:e.spaceId,pageId:e.pageId})]}function Ur(e){return{pointer:{table:"block",id:e.pageId,spaceId:e.pageId},path:[],command:"update",args:{last_edited_time:Date.now()}}}function Or(e){return{pointer:{table:"block",id:e.pageId,spaceId:e.spaceId},path:["format",e.propertyId],command:"set",args:e.value}}function Ar(e){return{pointer:{table:"block",id:e.pageId,spaceId:e.spaceId},path:["properties",e.propertyId],command:"set",args:e.value}}async function Mr(e,t){function n(a){chrome.runtime.sendMessage({popup:{name:"notionUploadFilePercent",args:{percent:a}}})}return t.notionClient.custom.uploadFile({dataB64:e.dataB64,onProgress:n,record:e.record})}async function jr(e,{}){return console.log("TODO"),{}}function Fr(e){return e.filter(t=>t!=null)}function de(){return R()}function wt(...e){return console.log("loadTweetV2.ts",...e)}async function $r(e,t){const n=await t.db.twitterSession.load(),a=new Dr(n);try{return await a.loadThread(e.tweetId,e.opts)}catch(i){return console.error(i),[]}}class Dr{constructor(t){this.defaultHeaders={accept:"*/*","accept-language":"en-US,en;q=0.9","accept-encoding":"gzip, deflate, br"},this.twitterSession=t}async fetchTweetDetail(t,n){return(await fetch(`https://x.com/i/api/graphql/7d8fexGPbM0BRc5DkacJqA/TweetDetail?variables=${Rn({focalTweetId:t,rux_context:"HHwWgICi-c7sl-gbAAAA",with_rux_injections:!0,...n&&{cursor:n},includePromotedContent:!0,withCommunity:!0,withQuickPromoteEligibilityTweetFields:!0,withBirdwatchNotes:!1,withDownvotePerspective:!1,withVoice:!0,withV2Timeline:!0})}
            &features=${Rn({blue_business_profile_image_shape_enabled:!1,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,responsive_web_graphql_timeline_navigation_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,tweetypie_unmention_optimization_enabled:!0,vibe_api_enabled:!0,responsive_web_edit_tweet_api_enabled:!0,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!0,view_counts_everywhere_api_enabled:!0,longform_notetweets_consumption_enabled:!0,tweet_awards_web_tipping_enabled:!1,freedom_of_speech_not_reach_fetch_enabled:!1,standardized_nudges_misinfo:!0,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!1,interactive_text_enabled:!0,responsive_web_text_conversations_enabled:!1,longform_notetweets_rich_text_read_enabled:!1,responsive_web_enhance_cards_enabled:!1})}`,{headers:{...this.defaultHeaders,authorization:this.twitterSession.authorization,"x-csrf-token":this.twitterSession.csrfToken,...this.twitterSession.guestToken?{"x-guest-token":this.twitterSession.guestToken}:{}}})).json()}async loadThread(t,n={}){wt("loadThread",t,n);const a={};let i=null,o=null,s=[];for(;;){const u=await this.fetchTweetDetail((o==null?void 0:o.id)||t,i);s=c(s,Br((o==null?void 0:o.id)||t,u,o,n));const d=s[s.length-1];if(d._meta.nextCursorId&&!a[d._meta.nextCursorId]?(a[d._meta.nextCursorId]=!0,i=d._meta.nextCursorId,o=d):(i=null,o=null),i==null)break}return s;function c(u,d){const p=u.map(g=>g.id),f=d.filter(g=>!p.includes(g.id));return[...u,...f]}}}function Rn(e){return encodeURIComponent(JSON.stringify(e))}function Br(e,t,n,a={}){var f;const i=(f=t.data.threaded_conversation_with_injections_v2)==null?void 0:f.instructions[0];if(!i)return[];const o=i.entries||i.moduleItems,s=Fr((o==null?void 0:o.flatMap((g,m)=>{var b,v,_,k,C,j,S,$,E,q;if(((b=g.content)==null?void 0:b.entryType)=="TimelineTimelineItem"){const A=g.content.itemContent.tweet_results;return A?[Nt(A,void 0,a)]:[]}else{if(((v=g.content)==null?void 0:v.entryType)=="TimelineTimelineModule")return((k=(_=g.content.items)==null?void 0:_.map((A,G)=>({block:A,pos:G})))==null?void 0:k.filter(({block:A})=>A.item.itemContent.itemType=="TimelineTweet").map(({block:A,pos:G})=>{var Y,H;let D=null;return(Y=g.content.items[G+1])!=null&&Y.item.itemContent.itemType.toLowerCase().includes("cursor")&&(D=((H=g.content.items[G+1])==null?void 0:H.item.itemContent).value),Nt(A.item.itemContent.tweet_results,D,a)}))||[];if(((j=(C=g.item)==null?void 0:C.itemContent)==null?void 0:j.itemType)=="TimelineTweet"){const A=((E=($=(S=o[m+1])==null?void 0:S.item)==null?void 0:$.itemContent)==null?void 0:E.itemType)=="TimelineTimelineCursor"&&((q=o[m+1])==null?void 0:q.item.itemContent.value);return[Nt(g.item.itemContent.tweet_results,A,a)]}}}))||[]);wt("tweets",s);const c=n||s.find(g=>g.id==e),u=[c,...s.filter(g=>{var m,b;return g.author.id==((m=c.author)==null?void 0:m.id)&&g._meta.replyingToUserId==((b=c.author)==null?void 0:b.id)})],d=Object.fromEntries(u.map(g=>[g.id,!1])),p=u.filter(g=>d[g.id]?!1:(d[g.id]=!0,!0));return wt("filtered tweets",p),p.map(g=>Lr(g))}function Lr(e){const t=Object.fromEntries(e.medias.map(a=>[a.shortenedUrl,a]));return Nr(e.text).forEach(a=>{t[a]&&(e.text=e.text.replace(a,""))}),e}function Nr(e){const t=/(https?:\/\/[^\s]+)/g;return e.match(t)||[]}function Wr(e){return e.replace(/(https:\/\/x.com\/[^\s]*\/status\/[^\s]*)/g,"")}function Rr(e,t){const n=Object.fromEntries(t.map(i=>[i.url,i.expanded_url]));let a=e;return Object.keys(n).forEach(i=>{a=a.replace(i,n[i])}),a}function Hr(e,t){function n(o){const s=/^(@\w+)/g,c=o.match(s);return c?{s:o.replace(c[0],"").trim(),continue:!0}:{s:o,continue:!1}}let a=!0,i=e;for(;a;){const o=n(i);a=o.continue,i=o.s}return i}function Nt(e,t,n={}){var m,b,v,_,k,C,j,S,$,E,q,A;let a=e.result.__typename=="TweetWithVisibilityResults"?e.result.tweet:e.result;if(!a||(a==null?void 0:a.__typename)=="TweetTombstone")return{id:`deleted-${(a==null?void 0:a.id_str)||de()}`,url:null,author:{id:"deleted",username:"deleted",name:"deleted"},createdAt:new Date().toISOString(),text:"This Post was deleted by the Post author.",medias:[],tweetEmbeds:[],_meta:{conversationId:"",replyingToUserId:""}};const i=a.legacy,o=(b=(m=a.core)==null?void 0:m.user_results)==null?void 0:b.result,s=((v=o.legacy)==null?void 0:v.screen_name)??"",c=((C=(k=(_=e.result.note_tweet)==null?void 0:_.note_tweet_results)==null?void 0:k.result)==null?void 0:C.text)??i.full_text,u=((E=($=(S=(j=e.result.note_tweet)==null?void 0:j.note_tweet_results)==null?void 0:S.result)==null?void 0:$.entity_set)==null?void 0:E.urls)??((A=(q=a.legacy)==null?void 0:q.entities)==null?void 0:A.urls)??[],d=g(),p=Hr(Wr(Rr(c,u)));return{id:i.id_str,url:`https://x.com/${s}/status/${i.id_str}`,author:{id:i.user_id_str,username:s,name:o.legacy.name},createdAt:new Date(i.created_at).toISOString(),text:p,medias:f(),tweetEmbeds:d,_meta:{conversationId:i.conversation_id_str,previousTweetId:i.in_reply_to_status_id_str,nextCursorId:t,replyingToUserId:i.in_reply_to_user_id_str||null}};function f(){var G;return((G=i.extended_entities)==null?void 0:G.media.map(D=>{var Ge,Ke,Qe,Je,Ye;const Y=((Qe=(Ke=(Ge=D.video_info)==null?void 0:Ge.variants)==null?void 0:Ke.filter(Ue=>Ue.content_type=="video/mp4").sort((Ue,xt)=>xt.bitrate-Ue.bitrate)[0])==null?void 0:Qe.url)||null,H=D.type=="photo",Pt=D.media_url_https+(H?n.uploadMaxQualityImages?"?name=orig":"?name=large":"");return{id:D.id_str,width:(Je=D.sizes.medium)==null?void 0:Je.w,height:(Ye=D.sizes.medium)==null?void 0:Ye.h,url:Pt,shortenedUrl:D.url,type:D.type,...Y&&{videoUrl:Y}}}))||[]}function g(){var D,Y;return wt("tweetContent.full_text",i,i.full_text),[...(D=i.entities)==null?void 0:D.urls.filter(H=>H.expanded_url.match(/https:\/\/x.com\/[^\s]*\/status\/[^\s]*/g)).map(H=>({url:H.expanded_url})),...((Y=i.full_text.match(/(https:\/\/x.com\/[^\s]*\/status\/[^\s]*)/g))==null?void 0:Y.map(H=>({url:H})))||[]]}}const Sa=Object.freeze(Object.defineProperty({__proto__:null,backgroundNetworkFetch:wr,loadTweetV2:$r,notionChangeOrderOptionProperty:kr,notionCreateNewOptionProperty:Ir,notionGetCollection:Sr,notionGetPageItem:Cr,notionSearchRelations:vr,notionUpdateOptionProperty:Ca,notionUpdatePageValues:xr,notionUploadFile:Mr,openQuickCapturePopup:jr},Symbol.toStringTag,{value:"Module"})),zr=Object.fromEntries(Object.keys(Sa).map(e=>[e,async t=>new Promise(n=>{chrome.runtime.sendMessage({type:"action",fnName:e,props:t},n)})])),st={pageFrontImageId:"pageFrontImage",pageIconId:"pageIcon",stripe:{buyLink:"https://buy.stripe.com/8wM5mY9dteBX1kA6op",manageBillingLink:"https://billing.stripe.com/p/login/28o7tceSsbDI1c4dQQ"},color:{text200:"#E7E5E4",text300:"#D6D3D1",text400:"#A8A29E",text700:"#44403C"},limits:{clipTwitterThread:3,clipEmail:6,showRemain:3,freeForms:5},signup:{privacyPolicyUrl:"https://anisg.notion.site/Privacy-Policy-Save-to-Notion-11e1ac17c54f42f1b7b6f95e5187ba32",termsOfServiceUrl:"https://anisg.notion.site/Terms-Conditions-Save-to-Notion-1e2e8dfb37bc408fb682ea2c9753ea6f"},auth:{clientId:"6mm6i3ehl149cicimepgkplu8i",cognitoUrl:"https://auth.savetonotion.so"},backend:{url:{}.REACT_APP_BACKEND=="local"?"http://localhost:3000":"https://6kbxs6snzg.execute-api.us-east-1.amazonaws.com/v1"},links:{changelog:"https://savetonotion.so/changelog"},marketing:{chromeExtensionReviewUrl:"https://chromewebstore.google.com/detail/save-to-notion/ldmmifpegigmeammaeckplhnjbbpccmm/reviews"}};class Hn{constructor(t){this.defaultHeaders={accept:"*/*","accept-language":"en-US,en;q=0.9","accept-encoding":"gzip, deflate, br"},this._refreshIdTokenIfNeeded=async()=>{if(!this.credentials)return!0;const n=zn(this.credentials.idToken);if(this.FIX_checkRefreshTokenExpired())throw new Error("Refresh token expired");if(this._checkIdTokenExpired(n)){const a=await this._axios("auth/refresh","post",{refreshToken:this.credentials.refreshToken,email:n.sub},{},{ignoreCheckTokenRefresh:!0,ignoreIdToken:!0});a.success&&await this._saveCredentials(a.credentials)}},this.auth={login:async n=>await this.post("auth/login",n),status:async()=>this.get("auth/status"),confirmCodeAndLogin:async n=>this.post("auth/signup-confirm-code-and-login",n),resetPassword:async n=>this.post("auth/reset-password",n),logout:async()=>this.post("auth/logout"),signupResendConfirmCode:async n=>this.post("auth/signup-resend-confirm-code",n),sendResetPasswordLink:async n=>this.post("auth/send-reset-password-link",n),signUp:async n=>await this.post("auth/signup",n),googleSsoCompleteLogin:async n=>await this.post("auth/google-sso-complete-login",n),getCognitoUrlWithSessionId:n=>{const a=n||R(),i={redirectionUri:`${st.backend.url}/auth/google-sso-callback`,clientId:st.auth.clientId,domain:st.auth.cognitoUrl},o=new URLSearchParams({client_id:i.clientId,response_type:"code",scope:"email openid profile",identity_provider:"Google",state:a,redirect_uri:i.redirectionUri}),s=`${i.domain}/oauth2/authorize?${o.toString()}`;return{sessionId:a,url:s}},changePassword:async n=>this.post("auth/change-password",n)},this.api={stripeCreateCheckoutSession:async n=>this.post("api/stripe/create-checkout-session",n),stripeConfirmCheckoutSession:async()=>this.post("api/stripe/confirm-checkout-session"),stripeManageSubscription:async()=>this.post("api/stripe/get-billing-portal"),loadSyncEntries:async n=>this.post("api/load-sync-entries",n),syncEntries:async n=>this.post("api/sync-entries",n),getUser:async()=>this.get("api/user"),pushSyncEntries:async n=>this.post("api/push-sync-entries",n),completeOnboarding:async()=>this.post("api/complete-onboarding"),togglePublishForm:async n=>this.post("/api/toggle-publish-form",n),loadSharedForms:async n=>this.post("/api/load-shared-forms",n),enableDataSync:async()=>this.post("api/enable-data-sync"),updateUser:async n=>this.post("api/update-user",{user:n}),updatePassword:async n=>this.post("api/update-password",n),updateEmail:async n=>this.post("api/update-email",n),verifyCodeAfterEmailUpdate:async n=>this.post("api/verify-code-after-email-update",n),resendVerificationCode:async n=>this.post("api/resend-verification-code",n)},this.integration={loadTweet:async n=>this.post("/integration/load-tweet",n)},this.custom={getForm:async n=>{var i,o;return(o=(i=(await this.api.loadSyncEntries({lastSyncAt:"2020-01-01T00:00:00.000Z",entries:[{name:"forms",id:n}]})).updatedEntries)==null?void 0:i[0])==null?void 0:o.value}},t&&(this.credentials=t.credentials,this.user=t.user)}_checkIdTokenExpired(t){return t.exp*1e3<Date.now()}FIX_checkRefreshTokenExpired(){const t=zn(this.credentials.accessToken),n=t.iat*1e3<Date.now()-1e3*60*60*24*30,a=t.iat*1e3<Date.parse("2023-10-01");return!!(n&&a)}_saveCredentials(t){return this.credentials=t,w.custom.saveUser({auth:{credentials:this.credentials,user:this.user}})}async _axios(t,n="get",a={},i={},o={}){var s;return o.ignoreCheckTokenRefresh||await this._refreshIdTokenIfNeeded(),zr.backgroundNetworkFetch({url:`${st.backend.url}${(t.startsWith("/")?t:`/${t}`)||t}`,props:{method:n.toUpperCase(),headers:{"content-type":"application/json",...this.defaultHeaders,...((s=this.credentials)==null?void 0:s.idToken)&&!o.ignoreIdToken&&{Authorization:this.credentials.idToken},...i},body:n in{post:!0,put:!0}?JSON.stringify(a):void 0}})}post(t,n={},a={}){return this._axios(t,"post",n,a)}put(t,n={},a={}){return this._axios(t,"put",n,a)}delete(t){return this._axios(t,"delete")}get(t){return this._axios(t,"get",null)}}function zn(e){return JSON.parse(atob(e.split(".")[1]))}var bt={exports:{}};bt.exports;(function(e,t){var n=200,a="__lodash_hash_undefined__",i=1,o=2,s=9007199254740991,c="[object Arguments]",u="[object Array]",d="[object AsyncFunction]",p="[object Boolean]",f="[object Date]",g="[object Error]",m="[object Function]",b="[object GeneratorFunction]",v="[object Map]",_="[object Number]",k="[object Null]",C="[object Object]",j="[object Promise]",S="[object Proxy]",$="[object RegExp]",E="[object Set]",q="[object String]",A="[object Symbol]",G="[object Undefined]",D="[object WeakMap]",Y="[object ArrayBuffer]",H="[object DataView]",Pt="[object Float32Array]",Ge="[object Float64Array]",Ke="[object Int8Array]",Qe="[object Int16Array]",Je="[object Int32Array]",Ye="[object Uint8Array]",Ue="[object Uint8ClampedArray]",xt="[object Uint16Array]",ei="[object Uint32Array]",ti=/[\\^$.*+?()[\]{}|]/g,ni=/^\[object .+?Constructor\]$/,ai=/^(?:0|[1-9]\d*)$/,T={};T[Pt]=T[Ge]=T[Ke]=T[Qe]=T[Je]=T[Ye]=T[Ue]=T[xt]=T[ei]=!0,T[c]=T[u]=T[Y]=T[p]=T[H]=T[f]=T[g]=T[m]=T[v]=T[_]=T[C]=T[$]=T[E]=T[q]=T[D]=!1;var pn=typeof window=="object"&&window&&window.Object===Object&&window,ii=typeof self=="object"&&self&&self.Object===Object&&self,se=pn||ii||Function("return this")(),gn=t&&!t.nodeType&&t,hn=gn&&!0&&e&&!e.nodeType&&e,fn=hn&&hn.exports===gn,Et=fn&&pn.process,mn=function(){try{return Et&&Et.binding&&Et.binding("util")}catch{}}(),yn=mn&&mn.isTypedArray;function oi(r,l){for(var h=-1,y=r==null?0:r.length,P=0,I=[];++h<y;){var O=r[h];l(O,h,r)&&(I[P++]=O)}return I}function ri(r,l){for(var h=-1,y=l.length,P=r.length;++h<y;)r[P+h]=l[h];return r}function si(r,l){for(var h=-1,y=r==null?0:r.length;++h<y;)if(l(r[h],h,r))return!0;return!1}function ci(r,l){for(var h=-1,y=Array(r);++h<r;)y[h]=l(h);return y}function li(r){return function(l){return r(l)}}function ui(r,l){return r.has(l)}function di(r,l){return r==null?void 0:r[l]}function pi(r){var l=-1,h=Array(r.size);return r.forEach(function(y,P){h[++l]=[P,y]}),h}function gi(r,l){return function(h){return r(l(h))}}function hi(r){var l=-1,h=Array(r.size);return r.forEach(function(y){h[++l]=y}),h}var fi=Array.prototype,mi=Function.prototype,Xe=Object.prototype,Ut=se["__core-js_shared__"],wn=mi.toString,ie=Xe.hasOwnProperty,bn=function(){var r=/[^.]+$/.exec(Ut&&Ut.keys&&Ut.keys.IE_PROTO||"");return r?"Symbol(src)_1."+r:""}(),_n=Xe.toString,yi=RegExp("^"+wn.call(ie).replace(ti,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),vn=fn?se.Buffer:void 0,Ze=se.Symbol,In=se.Uint8Array,kn=Xe.propertyIsEnumerable,wi=fi.splice,me=Ze?Ze.toStringTag:void 0,Cn=Object.getOwnPropertySymbols,bi=vn?vn.isBuffer:void 0,_i=gi(Object.keys,Object),Ot=Se(se,"DataView"),Oe=Se(se,"Map"),At=Se(se,"Promise"),Mt=Se(se,"Set"),jt=Se(se,"WeakMap"),Ae=Se(Object,"create"),vi=be(Ot),Ii=be(Oe),ki=be(At),Ci=be(Mt),Si=be(jt),Sn=Ze?Ze.prototype:void 0,Ft=Sn?Sn.valueOf:void 0;function ye(r){var l=-1,h=r==null?0:r.length;for(this.clear();++l<h;){var y=r[l];this.set(y[0],y[1])}}function Ti(){this.__data__=Ae?Ae(null):{},this.size=0}function Pi(r){var l=this.has(r)&&delete this.__data__[r];return this.size-=l?1:0,l}function xi(r){var l=this.__data__;if(Ae){var h=l[r];return h===a?void 0:h}return ie.call(l,r)?l[r]:void 0}function Ei(r){var l=this.__data__;return Ae?l[r]!==void 0:ie.call(l,r)}function Ui(r,l){var h=this.__data__;return this.size+=this.has(r)?0:1,h[r]=Ae&&l===void 0?a:l,this}ye.prototype.clear=Ti,ye.prototype.delete=Pi,ye.prototype.get=xi,ye.prototype.has=Ei,ye.prototype.set=Ui;function ce(r){var l=-1,h=r==null?0:r.length;for(this.clear();++l<h;){var y=r[l];this.set(y[0],y[1])}}function Oi(){this.__data__=[],this.size=0}function Ai(r){var l=this.__data__,h=tt(l,r);if(h<0)return!1;var y=l.length-1;return h==y?l.pop():wi.call(l,h,1),--this.size,!0}function Mi(r){var l=this.__data__,h=tt(l,r);return h<0?void 0:l[h][1]}function ji(r){return tt(this.__data__,r)>-1}function Fi(r,l){var h=this.__data__,y=tt(h,r);return y<0?(++this.size,h.push([r,l])):h[y][1]=l,this}ce.prototype.clear=Oi,ce.prototype.delete=Ai,ce.prototype.get=Mi,ce.prototype.has=ji,ce.prototype.set=Fi;function we(r){var l=-1,h=r==null?0:r.length;for(this.clear();++l<h;){var y=r[l];this.set(y[0],y[1])}}function $i(){this.size=0,this.__data__={hash:new ye,map:new(Oe||ce),string:new ye}}function Di(r){var l=nt(this,r).delete(r);return this.size-=l?1:0,l}function Bi(r){return nt(this,r).get(r)}function Li(r){return nt(this,r).has(r)}function Ni(r,l){var h=nt(this,r),y=h.size;return h.set(r,l),this.size+=h.size==y?0:1,this}we.prototype.clear=$i,we.prototype.delete=Di,we.prototype.get=Bi,we.prototype.has=Li,we.prototype.set=Ni;function et(r){var l=-1,h=r==null?0:r.length;for(this.__data__=new we;++l<h;)this.add(r[l])}function Wi(r){return this.__data__.set(r,a),this}function Ri(r){return this.__data__.has(r)}et.prototype.add=et.prototype.push=Wi,et.prototype.has=Ri;function pe(r){var l=this.__data__=new ce(r);this.size=l.size}function Hi(){this.__data__=new ce,this.size=0}function zi(r){var l=this.__data__,h=l.delete(r);return this.size=l.size,h}function Vi(r){return this.__data__.get(r)}function qi(r){return this.__data__.has(r)}function Gi(r,l){var h=this.__data__;if(h instanceof ce){var y=h.__data__;if(!Oe||y.length<n-1)return y.push([r,l]),this.size=++h.size,this;h=this.__data__=new we(y)}return h.set(r,l),this.size=h.size,this}pe.prototype.clear=Hi,pe.prototype.delete=zi,pe.prototype.get=Vi,pe.prototype.has=qi,pe.prototype.set=Gi;function Ki(r,l){var h=at(r),y=!h&&lo(r),P=!h&&!y&&$t(r),I=!h&&!y&&!P&&jn(r),O=h||y||P||I,B=O?ci(r.length,String):[],L=B.length;for(var U in r)(l||ie.call(r,U))&&!(O&&(U=="length"||P&&(U=="offset"||U=="parent")||I&&(U=="buffer"||U=="byteLength"||U=="byteOffset")||io(U,L)))&&B.push(U);return B}function tt(r,l){for(var h=r.length;h--;)if(Un(r[h][0],l))return h;return-1}function Qi(r,l,h){var y=l(r);return at(r)?y:ri(y,h(r))}function Me(r){return r==null?r===void 0?G:k:me&&me in Object(r)?no(r):co(r)}function Tn(r){return je(r)&&Me(r)==c}function Pn(r,l,h,y,P){return r===l?!0:r==null||l==null||!je(r)&&!je(l)?r!==r&&l!==l:Ji(r,l,h,y,Pn,P)}function Ji(r,l,h,y,P,I){var O=at(r),B=at(l),L=O?u:ge(r),U=B?u:ge(l);L=L==c?C:L,U=U==c?C:U;var z=L==C,X=U==C,W=L==U;if(W&&$t(r)){if(!$t(l))return!1;O=!0,z=!1}if(W&&!z)return I||(I=new pe),O||jn(r)?xn(r,l,h,y,P,I):eo(r,l,L,h,y,P,I);if(!(h&i)){var K=z&&ie.call(r,"__wrapped__"),Q=X&&ie.call(l,"__wrapped__");if(K||Q){var he=K?r.value():r,le=Q?l.value():l;return I||(I=new pe),P(he,le,h,y,I)}}return W?(I||(I=new pe),to(r,l,h,y,P,I)):!1}function Yi(r){if(!Mn(r)||ro(r))return!1;var l=On(r)?yi:ni;return l.test(be(r))}function Xi(r){return je(r)&&An(r.length)&&!!T[Me(r)]}function Zi(r){if(!so(r))return _i(r);var l=[];for(var h in Object(r))ie.call(r,h)&&h!="constructor"&&l.push(h);return l}function xn(r,l,h,y,P,I){var O=h&i,B=r.length,L=l.length;if(B!=L&&!(O&&L>B))return!1;var U=I.get(r);if(U&&I.get(l))return U==l;var z=-1,X=!0,W=h&o?new et:void 0;for(I.set(r,l),I.set(l,r);++z<B;){var K=r[z],Q=l[z];if(y)var he=O?y(Q,K,z,l,r,I):y(K,Q,z,r,l,I);if(he!==void 0){if(he)continue;X=!1;break}if(W){if(!si(l,function(le,_e){if(!ui(W,_e)&&(K===le||P(K,le,h,y,I)))return W.push(_e)})){X=!1;break}}else if(!(K===Q||P(K,Q,h,y,I))){X=!1;break}}return I.delete(r),I.delete(l),X}function eo(r,l,h,y,P,I,O){switch(h){case H:if(r.byteLength!=l.byteLength||r.byteOffset!=l.byteOffset)return!1;r=r.buffer,l=l.buffer;case Y:return!(r.byteLength!=l.byteLength||!I(new In(r),new In(l)));case p:case f:case _:return Un(+r,+l);case g:return r.name==l.name&&r.message==l.message;case $:case q:return r==l+"";case v:var B=pi;case E:var L=y&i;if(B||(B=hi),r.size!=l.size&&!L)return!1;var U=O.get(r);if(U)return U==l;y|=o,O.set(r,l);var z=xn(B(r),B(l),y,P,I,O);return O.delete(r),z;case A:if(Ft)return Ft.call(r)==Ft.call(l)}return!1}function to(r,l,h,y,P,I){var O=h&i,B=En(r),L=B.length,U=En(l),z=U.length;if(L!=z&&!O)return!1;for(var X=L;X--;){var W=B[X];if(!(O?W in l:ie.call(l,W)))return!1}var K=I.get(r);if(K&&I.get(l))return K==l;var Q=!0;I.set(r,l),I.set(l,r);for(var he=O;++X<L;){W=B[X];var le=r[W],_e=l[W];if(y)var Fn=O?y(_e,le,W,l,r,I):y(le,_e,W,r,l,I);if(!(Fn===void 0?le===_e||P(le,_e,h,y,I):Fn)){Q=!1;break}he||(he=W=="constructor")}if(Q&&!he){var it=r.constructor,ot=l.constructor;it!=ot&&"constructor"in r&&"constructor"in l&&!(typeof it=="function"&&it instanceof it&&typeof ot=="function"&&ot instanceof ot)&&(Q=!1)}return I.delete(r),I.delete(l),Q}function En(r){return Qi(r,go,ao)}function nt(r,l){var h=r.__data__;return oo(l)?h[typeof l=="string"?"string":"hash"]:h.map}function Se(r,l){var h=di(r,l);return Yi(h)?h:void 0}function no(r){var l=ie.call(r,me),h=r[me];try{r[me]=void 0;var y=!0}catch{}var P=_n.call(r);return y&&(l?r[me]=h:delete r[me]),P}var ao=Cn?function(r){return r==null?[]:(r=Object(r),oi(Cn(r),function(l){return kn.call(r,l)}))}:ho,ge=Me;(Ot&&ge(new Ot(new ArrayBuffer(1)))!=H||Oe&&ge(new Oe)!=v||At&&ge(At.resolve())!=j||Mt&&ge(new Mt)!=E||jt&&ge(new jt)!=D)&&(ge=function(r){var l=Me(r),h=l==C?r.constructor:void 0,y=h?be(h):"";if(y)switch(y){case vi:return H;case Ii:return v;case ki:return j;case Ci:return E;case Si:return D}return l});function io(r,l){return l=l??s,!!l&&(typeof r=="number"||ai.test(r))&&r>-1&&r%1==0&&r<l}function oo(r){var l=typeof r;return l=="string"||l=="number"||l=="symbol"||l=="boolean"?r!=="__proto__":r===null}function ro(r){return!!bn&&bn in r}function so(r){var l=r&&r.constructor,h=typeof l=="function"&&l.prototype||Xe;return r===h}function co(r){return _n.call(r)}function be(r){if(r!=null){try{return wn.call(r)}catch{}try{return r+""}catch{}}return""}function Un(r,l){return r===l||r!==r&&l!==l}var lo=Tn(function(){return arguments}())?Tn:function(r){return je(r)&&ie.call(r,"callee")&&!kn.call(r,"callee")},at=Array.isArray;function uo(r){return r!=null&&An(r.length)&&!On(r)}var $t=bi||fo;function po(r,l){return Pn(r,l)}function On(r){if(!Mn(r))return!1;var l=Me(r);return l==m||l==b||l==d||l==S}function An(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=s}function Mn(r){var l=typeof r;return r!=null&&(l=="object"||l=="function")}function je(r){return r!=null&&typeof r=="object"}var jn=yn?li(yn):Xi;function go(r){return uo(r)?Ki(r):Zi(r)}function ho(){return[]}function fo(){return!1}e.exports=po})(bt,bt.exports);var Vr=bt.exports;const Ta=fa(Vr);class qr{constructor(t,n,a={get:va,set:on,remove:ka,getAll:Ia}){this.watchableKeysMap={},this.pendingEntries=[],this.canSync=!1,this.watchableKeysMap=Object.fromEntries((t||[]).map(i=>[i,i in n?n[i]:o=>o])),this.localStorage=a,this.debouncedPushUpdates=Gr(()=>this.pushUpdates(),1e3)}_splitKey(t){const n=t.match(/^data-([^-]*)(?:-(.*))?$/);return n?{name:n[1],id:n[2]??null}:{name:t,id:null}}get(t,n){return this.localStorage.get(t,n)}async remove(t){const{name:n,id:a}=this._splitKey(t);return n in this.watchableKeysMap&&await this.addSyncEntry({name:n,id:a,action:"delete"}),this.localStorage.remove(t)}async set(t,n,a=!0){return a&&this.canSync&&await this.syncSet(t,n),this.localStorage.set(t,n)}async syncSet(t,n,a){if(!this.canSync&&!a)return;const{name:i,id:o}=this._splitKey(t);i in this.watchableKeysMap&&await this.addSyncEntry({name:i,id:o,value:this.watchableKeysMap[i](n),action:"set"})}async addSyncEntry(t){this.canSync&&(this.pendingEntries.push(t),this.debouncedPushUpdates())}_removedDupEntries(t){const n=Object.fromEntries(t.map(a=>[`${a.name}-${a.id}`,a]));return Object.values(n)}async _saveEntriesInCache(t){const n=Object.fromEntries(t.map(a=>[`${a.name}-${a.id}`,a]));for(const[a,i]of Object.entries(n))i.action=="set"?await this.localStorage.set("sync-"+a,i.value):i.action=="delete"&&await this.localStorage.remove("sync-"+a)}async getValidEntries(t){const n=Object.fromEntries(t.map(i=>[`${i.name}-${i.id}`,i])),a=[];for(const[i,o]of Object.entries(n)){const s=await this.localStorage.get("sync-"+i,null);o.action=="set"?Ta(s,o.value)||a.push(o):o.action=="delete"&&s!=null&&a.push(o)}return a}attachSharedIdToEntries(t){return t.map(n=>{var a,i;return n.name=="forms"&&n.action=="set"&&((a=n.value)!=null&&a.isPublic)?{...n,sharedSpaceId:(i=n.value)==null?void 0:i.spaceId}:n})}async pushUpdates(t){var o,s,c,u;const n=this.attachSharedIdToEntries(this._removedDupEntries(this.pendingEntries));if(!n.length)return;this.pendingEntries=[];const a=await this.localStorage.get("data-user",null);if(!a||!((s=(o=a.auth)==null?void 0:o.credentials)!=null&&s.idToken)||!((u=(c=a.auth)==null?void 0:c.user)!=null&&u.dataSyncEnabled)&&!t)return;await new Hn(a.auth).api.pushSyncEntries({entries:n})}async pullUpdates(t){var c,u;const n=new Date(2e3,0,1).toISOString(),a=await this.localStorage.get("data-user",null);if(!a||!((u=(c=a.auth)==null?void 0:c.credentials)!=null&&u.idToken))return;const i=n;return await new Hn(a.auth).api.syncEntries({lastSyncAt:i,spaces:Object.fromEntries((t??[]).map(d=>[d,i]))})}getAll(t){return this.localStorage.getAll(t)}turnOnSync(){this.canSync=!0}turnOffSync(){this.canSync=!1}}function Gr(e,t){let n=null;return function(){n&&clearTimeout(n),n=setTimeout(e,t)}}const Vn=new qr(["forms","user"],{user:e=>({forms:e.forms,settings:te(e.settings||{},"showFloatingQuickAddButton")})}),Pa={user:M("user",{forms:[],settings:Ve,capturedWebpages:[]},Vn,["forms","settings"]),form:x("forms",null,Vn),notionCollection:x("notionCollections"),notionPage:x("notionPage"),capturedWebpage:x("capturedWebpage",null),urlToCapturedWebpage:x("urlToCapturedWebpage",null),highlight:x("highlight",null),notionSync:M("notionSync",{pendingEvents:[],failedEvents:[]}),notionCollectionFormatOptions:x("notionCollectionFormatOptions",null),recent:M("recent",null),lastUpdated:M("lastUpdated",{spaces:{}}),twitterSession:M("twitterSession",null),twitterIntegrationUsage:M("countThreadUsage",{threadSavedCount:0}),info:M("info",{installedAt:null}),quickCapture:M("quickCapture",null),gmailIntegrationUsage:M("gmailIntegrationUsage",{savedCount:0}),quickCaptureSession:M("quickCaptureSession",null),imageEditorConfig:M("imageEditorConfig",null),tooltipSession:M("tooltipSession",null),captureContext:M("captureContext",null),toastSession:M("toastSession",{events:[]}),imageCacheInfo:M("imageCacheInfo",{cachedUrls:[]}),imageCaches:x("imageCaches",null)},Kr={storageKeysToRemove:[],async up(e,t){return{...e,notionPage:{}}}};function qe(e){return e==null?void 0:e.replace(/#.*$/,"")}const $e=[{db:or,migration:er},{db:Zo,migration:nr},{db:rr,migration:sr},{db:cr,migration:ur},{db:dr,migration:pr},{db:Pa,migration:Kr}];function qn(e,t){return Object.keys(e).reduce((n,a)=>n&&Ta(e[a],t[a]),!0)}const w=Xo({...Pa,custom:{async saveUser(e){const t=await w.user.load();return!t||!qn(e,t)?await w.user.save(e):e},async saveForm(e){const t=e.collection,n=e.page;await Promise.all([t&&w.notionCollection.save(t.id,t),n&&w.notionPage.save(n.id,n),(async()=>{const a={...te(e,"collection","page","daps"),...t&&{notionCollectionId:t.id,notionParentCollectionId:t.parent_id},...n&&{notionPageId:n.id},fields:e.daps},i=await w.form.get(e.id);(!i||!qn(a,i))&&await w.form.save(e.id,a)})()])},async createCapturedWebpage(e){let t=null;return e.url&&(t=qe(e.url),await w.urlToCapturedWebpage.save(t,{url:t,capturedWebpageId:e.capturedWebpageId})),await w.capturedWebpage.save(e.capturedWebpageId,{...e.savingTo&&{savingTo:e.savingTo,notionBookmarkId:e.notionBookmarkId},id:e.capturedWebpageId,url:t,title:e.title,notionCollectionId:e.notionCollectionId,notionPageId:e.notionPageId,notionSpaceId:e.notionSpaceId,icon:e.icon,clipFormat:We.bookmark,formId:e.formId,notionListAfterId:e.notionListAfterId,createdAt:new Date().toISOString(),highlights:[],...e.source&&{source:e.source}})},async createHighlight(e){const t=await w.capturedWebpage.get(e.capturedWebpageId);if(!t)throw new Error("capturedWebpage not found");await w.capturedWebpage.save(e.capturedWebpageId,{...t,highlights:[...t.highlights,e.id]});const n={...e,id:e.id,_sync:"pending"};return await w.highlight.save(e.id,te(n,"properties")),n}}});function Qr(e){var n,a,i;const t=(n=Object.entries(e==null?void 0:e.spacesMap))==null?void 0:n.map(([o,s])=>{var u;return{id:o,name:s.name,icon:s.icon,planInfo:s.planInfo,user:e.usersMap[(u=s.linkedUserIds)==null?void 0:u[0]],customEmojisMap:s.customEmojisMap}});return{id:(i=(a=t[0])==null?void 0:a.user)==null?void 0:i.id,givenName:null,spaces:t,spacesMap:Object.fromEntries(t.map(o=>[o.id,o])),spacePersonsMap:e.spacePersonsMap}}var ut,ua,da,St=((da=(ua=(ut=chrome==null?void 0:chrome.runtime)==null?void 0:ut.getManifest)==null?void 0:ua.call(ut))==null?void 0:da.description.includes("Safari"))??!1;function Jr(e,t,n,a){const i=a||R();let o={id:i,table:"block",path:[],command:"update",args:{}},s=[o];if(e.role=="none")return{id:i,ops:[{...o,args:{type:"text",parent_id:t}}]};let c=e.value;return o.args={...te(c,"is_template","created_time","last_edited_time","content"),id:i,parent_id:t,copied_from:c.id},c.content,{id:i,ops:s}}async function Yr(e){return await J.get(`page-${e}`,null)}async function Xr(e,t,n){return Jr(e[t],void 0,e,n).ops}async function Zr(e,t){return await fetch(e,t)}var sn={exports:{}},cn={exports:{}};const xa=(e,...t)=>new Promise(n=>{n(e(...t))});cn.exports=xa;cn.exports.default=xa;var es=cn.exports;const ts=es,Ea=e=>{if(!((Number.isInteger(e)||e===1/0)&&e>0))return Promise.reject(new TypeError("Expected `concurrency` to be a number from 1 and up"));const t=[];let n=0;const a=()=>{n--,t.length>0&&t.shift()()},i=(c,u,...d)=>{n++;const p=ts(c,...d);u(p),p.then(a,a)},o=(c,u,...d)=>{n<e?i(c,u,...d):t.push(i.bind(null,c,u,...d))},s=(c,...u)=>new Promise(d=>o(c,d,...u));return Object.defineProperties(s,{activeCount:{get:()=>n},pendingCount:{get:()=>t.length},clearQueue:{value:()=>{t.length=0}}}),s};sn.exports=Ea;sn.exports.default=Ea;var ns=sn.exports;const as=fa(ns);function is(e,t){var n;return(n=e.match(new RegExp(`https://.*?/${t}/(.*?)/.*`)))==null?void 0:n[1]}function os(e){return e.includes("/")?e.split("/")[1]:null}class He{constructor({token:t,activeUserId:n}){this.defaultHeaders={accept:"*/*","accept-language":"en-US,en;q=0.9","accept-encoding":"gzip, deflate, br",origin:"https://www.notion.so",referer:"https://www.notion.so"},this.custom={saveTransaction:async a=>this.post("/saveTransactions",{requestId:de(),transactions:[{id:de(),spaceId:a.spaceId,operations:a.operations}]}),saveBlock:async a=>{},search:async a=>this.search({type:"BlocksInSpace",query:a.text,spaceId:a.spaceId,limit:20,filters:{isDeletedOnly:!1,excludeTemplates:!0,isNavigableOnly:!1,navigableBlockContentOnly:!0,requireEditPermissions:!1,includePublicPagesWithoutExplicitAccess:!1,ancestors:[],createdBy:[],editedBy:[],lastEditedTime:{},createdTime:{},inTeams:[]},sort:{field:"relevance"},source:"quick_find_input_change",searchExperimentOverrides:{},searchSessionId:de(),searchSessionFlowNumber:1,recentPagesForBoosting:[]}),createAsyncTaskToCopyTemplateContent:async({templateId:a,targetPageId:i,currentUserId:o,spaceId:s})=>{await this.post("/enqueueTask",{task:{eventName:"duplicateBlock",request:{sourceBlock:{id:a,spaceId:s},targetBlock:{id:i,spaceId:s},appendContentOnly:!0,resolveTemplateVariables:{currentUserId:o,currentTimeZone:"Europe/Vienna"}}}})},getPage:async a=>{var o,s,c;const i=await this.post("/syncRecordValues",{requests:[{pointer:{table:"block",id:a.pageId},version:-1}]});return{value:(c=(s=(o=i==null?void 0:i.recordMap)==null?void 0:o.block)==null?void 0:s[a.pageId])==null?void 0:c.value}},getCollection:async a=>{var o,s,c;return{value:(c=(s=(o=(await this.loadPageChunk({pageId:a.pageId??a.parentCollectionId})).recordMap)==null?void 0:o.collection)==null?void 0:s[a.collectionId])==null?void 0:c.value}},getSpacePersons:async({spaceId:a})=>{var c;const i=await this.post("/getVisibleUsers",{spaceId:a}),o=new mo(4);let s=[];return(c=i.users||i.visibleUsers)==null||c.forEach(u=>{o.push(async()=>{var f,g,m,b;const d=await this.post("/syncRecordValues",{requests:[{pointer:{table:"notion_user",id:u.userId},version:-1}]});let p=((f=d==null?void 0:d.recordMap)==null?void 0:f.notion_user)&&((b=(m=d==null?void 0:d.recordMap)==null?void 0:m.notion_user[Object.keys((g=d==null?void 0:d.recordMap)==null?void 0:g.notion_user)[0]])==null?void 0:b.value);p&&s.push(p)})}),await o.totallyEmpty(),s},uploadFile:async({dataB64:a,onProgress:i,record:o,noBlob:s,name:c})=>{var f;let u=a.substr(5,a.indexOf(";")-5);console.log("gonna upload 1/2...");const d=await this.post("/getUploadFileUrl",{bucket:"secure",name:c??`stn-${Yt(40)}.${os(u)??"jpg"}`,contentType:u,record:o,supportExtraHeaders:!1,contentLength:a.length}),p=is(d.url,o.spaceId);console.log("gonna upload 2/2...");try{const g=await Zr(d.signedPutUrl,{headers:{"Content-Type":u,...Object.fromEntries(((f=d.putHeaders)==null?void 0:f.map(m=>[m.name,m.value]))||[])},method:"PUT",body:s?a:yo(a),onProgress:i});return ne("resp upload to Notion",g),ne("vv",d.url,p),{success:!0,url:d.url,fileId:p}}catch(g){return console.error("error uploading",g),{success:!1}}},createWebClippedPage:async(a,{title:i,url:o})=>{var c;const s=await this.addWebClipperURLs({blockId:a,items:[{title:i,url:o}],from:"chrome",type:"block"});if(!s.createdBlockIds&&!((c=s.createdBlockIds)!=null&&c[0]))throw new Error(`addWebClipperURLs failed with following content: ${JSON.stringify(s)} - might be an expired token`);return s.createdBlockIds[0]},setCaption:async a=>(await this.submitOperations([{pointer:{id:a.notionBlockId,table:"block",spaceId:a.notionSpaceId},path:["properties","caption"],command:"set",args:[[a.caption]],size:5}],a.notionSpaceId),null),getSpaceIds:async()=>{var s;const a=await this.post("/getSpaces");let i={};return Object.keys(a).forEach(c=>{var u;i={...i,...((u=a[c])==null?void 0:u.space_view)||{}}}),(s=Object.keys(i))==null?void 0:s.map(c=>{var d;return(d=i[c].value)==null?void 0:d.space_id}).filter(c=>c!=null)},getUsers:async()=>{var s;const a=await this.post("/getSpaces");let i={};return Object.keys(a).forEach(c=>{var d,p,f;if(!a[c].notion_user)return;let u=((d=a[c].notion_user[c])==null?void 0:d.value)||{id:c};i[c]={...u,spaceIds:[]},i[c].spaceIds=(f=Object.keys(((p=a[c])==null?void 0:p.space_view)||{}))==null?void 0:f.map(g=>{var m,b,v;return(v=(b=(m=a[c])==null?void 0:m.space_view[g])==null?void 0:b.value)==null?void 0:v.space_id})}),(s=Object.keys(i))==null?void 0:s.map(c=>i[c])},getPublicSpaceData:async(a,i)=>{let o=[];for(let s of a){const c=await this.post("/getPublicSpaceData",{type:"space-ids",spaceIds:[s]},{"x-notion-active-user-header":i,"x-notion-space-id":s});o.push(...c.results)}return o},_getInviteeSpaces:a=>{},getUsersAndSpaces:async()=>{var d;const a={usersMap:{},spacesMap:{}},i=await this.post("/getSpaces");let o=a.usersMap;a.spacesMap={},Object.keys(i).forEach(p=>{var g,m,b;if(!i[p].notion_user)return;let f=((g=i[p].notion_user[p])==null?void 0:g.value)||{id:p,email:null};o[p]={...f,spaceIds:[]},o[p].spaceIds=(b=Object.keys(((m=i[p])==null?void 0:m.space_view)||{}))==null?void 0:b.map(v=>{var _,k,C;return(C=(k=(_=i[p])==null?void 0:_.space_view[v])==null?void 0:k.value)==null?void 0:C.space_id})});let s=(d=Object.keys(o))==null?void 0:d.map(p=>o[p]),c=a.spacesMap;Object.keys(i).forEach(p=>{const f=Object.entries(i[p].space);(f==null?void 0:f.map(([m,b])=>{const v=b.value;return{linkedUserIds:s.filter(_=>_.spaceIds.find(k=>k==v.id)!=null).map(_=>_.id),id:v.id,spaceId:v.id,type:"space",name:v.name,icon:v.icon,planInfo:v.plan_type?`${rs(v.plan_type||"Unknown")} Plan`:"Guest Access - Invited"}})).forEach(m=>{m.id in c||(c[m.id]=m)})});const u=as(5);try{await Promise.all(Object.keys(i).map(p=>u(async()=>{var b;const f=Object.keys(i[p].space_view).filter(v=>{var k,C;const _=(C=(k=i[p].space_view[v])==null?void 0:k.value)==null?void 0:C.space_id;return!i[p].space[_]}).map(v=>{var _,k;return(k=(_=i[p].space_view[v])==null?void 0:_.value)==null?void 0:k.space_id});((b=(await this.custom.getPublicSpaceData(f,p)).filter(v=>v))==null?void 0:b.map(v=>{const _=v;return{linkedUserIds:s.filter(k=>k.spaceIds.find(C=>C==_.id)!=null).map(k=>k.id),id:_.id,spaceId:_.id,type:"space",name:_.name,icon:_.icon,planInfo:"Guest Access - Invited"}})).forEach(v=>{v.id in c||(c[v.id]=v)})}))),await Promise.all(Object.keys(c).map(p=>u(async()=>{var f;try{const g=await this.post("/getCustomEmojisForSpace",{spaceId:p});if((f=g==null?void 0:g.recordMap)!=null&&f.custom_emoji){const m={};Object.entries(g.recordMap.custom_emoji).forEach(([b,v])=>{var k;const _=(k=v.value)!=null&&k.value?v.value.value:v.value;m[b]=_}),c[p]={...c[p],customEmojisMap:m}}}catch(g){console.error(`Error fetching custom emojis for space ${p}:`,g)}})))}catch(p){console.error("Error fetching invitee spaces",p)}return a},addBlockGetOperations:a=>{var u;const i=R();let o=dt(a.notionParentId);const s={[F.bullet]:{type:"bulleted_list"},[F.code]:{type:"code",properties:{language:[["Plain Text"]]}},[F.toggle]:{type:"toggle"},[F.quote]:{type:"quote"},page:{type:"page"},callout:{type:"callout",format:{page_icon:a.calloutIcon??"📋"}}},c=[{id:i,table:"block",path:[],command:"update",args:pa([{type:"bulleted_list",id:i,space_id:a.notionSpaceId,parent_id:o,parent_table:a.notionParentTable||"block",alive:!0,version:1,created_time:Date.now(),last_edited_time:Date.now(),...a.userId&&{created_by_table:"notion_user",created_by_id:a.userId,last_edited_by_table:"notion_user",last_edited_by_id:a.userId},properties:{...a.text&&{title:Array.isArray(a.text)?a.text:[[a.text]]},...a.properties||{}}},s[a.blockFormat]||{type:a.blockFormat},a.properties&&{properties:a.properties}||{},a.format&&{format:a.format}||{},a.fileIds&&{file_ids:a.fileIds}||{},a.withChildren&&{content:a.withChildren.content}||{}])},...a.blockFormat!="page"||a.isSubpage?[{table:"block",id:o,path:["content"],command:(a.afterId,"listAfter"),args:{...a.afterId?{after:a.afterId}:{},id:i}}]:[],...a.blockColor&&[{table:"block",id:i,path:["format"],command:"update",args:{block_color:a.blockColor}}]||[],...((u=a.withChildren)==null?void 0:u.contentBlocks)&&a.withChildren.contentBlocks.map(d=>({table:"block",id:d.value.id,path:[],command:"update",args:{parent_id:i,parent_table:"block",space_id:a.notionSpaceId,...d.value}}))||[]];return{newBlockId:i,operations:c}},addBlock:async a=>{let i=[];const{operations:o,newBlockId:s}=this.custom.addBlockGetOperations(a);a.extraOperationsFn?i=[...o,...a.extraOperationsFn({newBlockId:s,operations:o})]:i=o;const c=ss(i,500);for(let u of c)await this.submitOperations(u,a.notionSpaceId);return a.withCallback&&await a.withCallback(s),s},updateBlockText:async a=>{let i=dt(a.notionParentId);await this.submitOperations([{pointer:{table:"block",id:a.notionBlockId,spaceId:a.notionSpaceId},path:["properties","title"],command:"set",args:[[a.text]]},{pointer:{table:"block",id:a.notionBlockId,spaceId:a.notionSpaceId},path:[],command:"update",args:{last_edited_time:Date.now()}},{pointer:{table:"block",id:i,spaceId:a.notionSpaceId},path:[],command:"update",args:{last_edited_time:Date.now()}}],a.notionSpaceId)},removeBlock:a=>{this.submitOperations([{pointer:{table:"block",id:a.notionBlockId,spaceId:a.notionSpaceId},path:[],command:"update",args:{alive:!1}},{pointer:{table:"block",id:a.notionParentId,spaceId:a.notionSpaceId},path:["content"],command:"listRemove",args:{id:a.notionBlockId}}],a.notionSpaceId)},addBookmark:async a=>{const i=R();let o=dt(a.notionParentId);return await this.submitOperations([{id:i,table:"block",path:[],command:"update",args:{type:"text",id:i,parent_id:o,parent_table:"block",alive:!0,version:1,created_time:Date.now(),last_edited_time:Date.now(),properties:{title:[["[🔗 LINK]",[["a",a.url]]],[` — ${a.title.trim()||"Untitled"}`]]}}},{table:"block",id:o,path:["content"],command:"listAfter",args:{id:i}}],a.notionSpaceId),i},loadNotionContext:async()=>this.custom.getUsersAndSpaces()},this.token=t,this.activeUserId=n}async _axios(t,n="get",a={},i={}){let o;const s=this._fetch??fetch;if(console.log("perform a call..."),o=await s(`https://www.notion.so/api/v3/${t.startsWith("/")&&t.slice(1)||t}`,{method:n.toUpperCase(),headers:{"content-type":"application/json",...this.defaultHeaders,...this.activeUserId&&{"x-notion-active-user-header":this.activeUserId},...i},body:JSON.stringify(a)}),console.log("Done call",o),!o.ok)throw new Error(`Notion API returned ${o.status} for route ${t}`);return o.json()}post(t,n={},a={}){return this._axios(t,"post",n,a)}put(t,n={},a={}){return this._axios(t,"put",n,a)}delete(t){return this._axios(t,"delete")}get(t){return this._axios(t,"get",null)}_setFetch(t){this._fetch=t}addWebClipperURLs(t){return this.post("/addWebClipperURLs",t)}submitOperations(t,n){return this.post("/submitTransaction",{requestId:R(),transactions:[{id:R(),operations:t}]})}loadPageChunk(t){const n={limit:100,cursor:{stack:[]},chunkNumber:0,verticalColumns:!1};return this.post("/loadPageChunk",{...n,...t})}saveOperations(t,n){return this.post("/saveTransactions",{requestId:R(),transactions:[{id:R(),spaceId:n,operations:t}]})}search(t){return this.post("/search",t)}}function rs(e){return e.charAt(0).toUpperCase()+e.slice(1)}function ss(e,t){let n=[];for(let a=0;a<e.length;a+=t)n.push(e.slice(a,a+t));return n}const cs=e=>`${e.substr(0,8)}-${e.substr(8,4)}-${e.substr(12,4)}-${e.substr(16,4)}-${e.substr(20)}`,dt=e=>{if(e){const t=e.replace(/\-/g,"").slice(-32);return cs(t)}};function ls(e){return e.split("/").pop().split("#")[0].split("?")[0]}function us(e,{imgUrl:t,fileId:n,width:a,height:i,opts:o}){const s=R(),c=(o.addDivider==!0||o.addDivider===void 0)&&R(),u={large:{width:672,height:380},normal:{width:672,height:250},small:{width:336,height:175}},d=u[o.size].width,p=u[o.size].height;let f=null,g=null,m=!1,b=!1;switch(o.type){case"coverLike":o.size=="large"&&(b=!0),f=a,g=i,f!=d&&(g=Math.floor(g*(d/f)),f=d),g>p&&(f=Math.floor(f*(p/g)),g=p),f<d&&(b=!1),g=null;break;case"fullWidthCover":m=!0,g=p;break}return{newBlockId:s,newDividerBlockId:c,operations:[{id:s,table:"block",path:[],command:"set",args:{type:"text",id:s,version:1}},{id:s,table:"block",path:[],command:"update",args:{parent_id:e,parent_table:"block",alive:!0}},{table:"block",id:e,path:["content"],command:"listBefore",args:{id:s}},{id:s,table:"block",path:[],command:"update",args:{type:"image"}},{id:s,table:"block",path:["properties"],command:"update",args:{source:[[t]]}},{id:s,table:"block",path:["format"],command:"update",args:{display_source:t}},{id:s,table:"block",path:["format"],command:"update",args:{block_height:g,block_width:f,block_full_width:m,block_page_width:b}},...n&&[{id:s,table:"block",path:["file_ids"],command:"set",args:[n]}]||[],...c&&[{id:c,table:"block",path:[],command:"set",args:{type:"divider",id:c,properties:{}}},{id:c,table:"block",path:[],command:"update",args:{parent_id:e,parent_table:"block",alive:!0}},{table:"block",id:e,path:["content"],command:"listAfter",args:{after:s,id:c}}]||[]]}}const ds={"youtube.com":!0};class ps{constructor(t,n,a,i,o){this.id=t,this.parentId=a,this.fetched=!1,this.schema={},this.viewId=n,this.rows={},this.spaceId=o,this.client=i}initLocally(t){this._extractSchema(t),this.fetched=!0}_extractSchema(t){this.schema={};for(let n of Object.keys(t)){let a=t[n];this.schema[n]={...a,id:n,strippedName:""}}}async createRow(t,n,a,i){let o=[],s=null;if(a==ya.defaultClip&&(i!=null&&i.url))s=await new He({token:this.client.authToken,activeUserId:this.client.agent.activeUserId}).custom.createWebClippedPage(this.parentId,{title:t.title??"No title",url:i.url});else{let{id:u,operations:d}=this.client.createRecordOperations("block",{id:this.id,_table:"collection",spaceId:n},{type:"page"});s=u,o=d}this.rows[s]={id:s};let c=!1;if(i)try{let u=new URL(i.url);(u.hostname.startsWith("www.")&&u.hostname.substring(4)||u.hostname)in ds&&(c=!1)}catch{}return this.updateRow({where:{id:s},data:t,operations:o,skipFrontImage:c})}findRow({where:t}){if(t.id&&t.id in this.rows)return this.rows[t.id];let n=Object.keys(t).length;for(let a in this.rows){let i=this.rows[a],o=0;for(let s in t)if(i[s]==t[s])o++;else break;if(o==n)return i}return null}async updateRow({where:t,data:n,operations:a,skipFrontImage:i}){var m,b,v;let o=[],s=null,c=a,u=this.findRow({where:t});if(!u)throw"can't update because row not found";let d=u.id;if(n.__template){const _=await Xr(n.__template.blocksMap,n.__template.id,u.id);c.push(..._)}let p=[];n.pageFrontImage&&i==!1&&[...n.pageFrontImage].reverse().forEach((_,k)=>{const{newBlockId:C,newDividerBlockId:j,operations:S}=us(u.id,{..._,opts:{..._.opts,addDivider:k===0}});c.push(...S),s=j||C});for(let _ in n){if(_=="__template"||_=="pageFrontImage")continue;(m=n[_])!=null&&m.fileId&&p.push(n[_].fileId),Array.isArray(n[_])&&n[_].forEach(S=>{S.fileId&&p.push(S.fileId),_=="pageCover"?o.push({path:["format","page_cover"],value:S.imgUrl}):_=="pageIcon"&&o.push({path:["format","page_icon"],value:S.imgUrl})});let k=this.schema[_];if(!k)continue;let C=["properties",k.id],j=Pr(n[_],k);o.push({path:C,value:j})}p.length&&o.push({path:["file_ids"],value:p}),await this.client.updateDataRecord(d,o,c),n.__template&&await g({clientAuthToken:this.client.authToken,currentUserId:(v=(b=this.client.user.spacesMap[this.spaceId])==null?void 0:b.user)==null?void 0:v.id,spaceId:this.spaceId,activeUserId:this.client.agent.activeUserId});let f=this.rows[d];for(let _ in n)f[_]=n[_];return{id:f.id,highlightAfterId:s};async function g({clientAuthToken:_,currentUserId:k,spaceId:C,activeUserId:j}){await Do(30),await new He({token:_,activeUserId:j}).custom.createAsyncTaskToCopyTemplateContent({templateId:n.__template.id,targetPageId:u.id,currentUserId:k,spaceId:C})}}}function Gn(e,t,n){var o,s,c,u;let a=[],i=(o=e[n??"block"])==null?void 0:o[t];for(;i!=null&&i.value;)i.value.type=="page"&&a.push({name:Re(i.value.properties,"title","Untitled"),icon:((s=i.value.format)==null?void 0:s.page_icon)||null}),i=((u=e[i.parent_table??"block"])==null?void 0:u[(c=i.value)==null?void 0:c.parent_id])||null;return a.reverse(),a}const gs={id:null,spaces:[],givenName:null,spacesMap:{},spacePersonsMap:{}};class hs{constructor(t,n){this.agent=$o({token:t,debug:!1,activeUserId:n}),this.authToken=t,this.user=gs}async setActiveUserId(t){this.agent.activeUserId=t,J.set(It,t)}async addValueToPropertyCollection(t,n,a,i,o){let s={...t.schema},c={id:i,value:a,color:o};return s[n]={...s[n],options:[...s[n].options||[],c]},await this._submitTransaction([{id:t.id,table:"collection",path:[],command:"update",args:{schema:s}}]),c}setUserInfos(t){this.user=t}loadPageChunk(t){return this.agent.loadPageChunk(t)}async checkPageAlive(t){var a,i,o,s;const n=await this.agent._post("/api/v3/syncRecordValues",{requests:[{pointer:{table:"block",id:t},version:-1}]});return{alive:(s=(o=(i=(a=n==null?void 0:n.recordMap)==null?void 0:a.block)==null?void 0:i[t])==null?void 0:o.value)==null?void 0:s.alive}}async fetchUserInfos(){const t=await this.agent.loadUserContent({});let n=Object.keys(t.recordMap.notion_user);this.user.id=n[0];let a=t.recordMap.notion_user[this.user.id];this.user.givenName=a.value.given_name;for(let i in t.recordMap.space){let o=t.recordMap.space[i];this.user.spaces.push({id:i,name:o.value.name})}}createRecordOperations(t,n,a={}){let i=R(),o={id:i,version:1,alive:!0,created_by:this.agent.activeUserId,created_time:Date.now(),space_id:n.spaceId,last_edited_by:this.agent.activeUserId,last_edited_time:Date.now(),parent_id:n.id,parent_table:n._table,...a};return{id:i,operations:[this._buildOperation({id:i,command:"set",args:o,table:t})]}}async createRecord(t,n,a={}){let i=a.id||R(),o={id:i,version:1,alive:!0,created_by:this.user.id,created_time:Date.now(),last_edited_by:this.user.id,last_edited_time:Date.now(),parent_id:n.id,parent_table:n._table,...a};return await this._submitTransaction([this._buildOperation({id:i,command:"set",args:o,table:t})]),i}async updateDataRecord(t,n,a){return await this._submitTransaction([...a||[],...n==null?void 0:n.map(i=>this._buildOperation({id:t,command:"set",table:"block",path:i.path,args:i.value}))]),t}async getCollectionLocally(t,n,a,i){let o=new ps(t,"",n,this,i);return o.initLocally(a),o}_buildOperation(t){return t={table:"block",path:[],args:{},command:"set",...t},{id:t.id,path:t.path,args:t.args,command:t.command,table:t.table}}async searchCollectionPages(t,n,a,i=this.user.id){var c,u;let o=await this.agent.search({type:"BlocksInParent",query:t,spaceId:a,parentId:n,limit:20,filters:{isDeletedOnly:!1,excludeTemplates:!0,isNavigableOnly:!0,requireEditPermissions:!1,ancestors:[],createdBy:[],editedBy:[],lastEditedTime:{},createdTime:{}},sort:"Relevance",source:"relation_menu"}),s=[];for(let d of o.results){let p=d.id;if(!(p in o.recordMap.block))continue;let f=o.recordMap.block[p].value;s.push({id:f.id,name:Re(f.properties,"title","Untitled"),title:(c=f.properties)==null?void 0:c.title,icon:((u=f.format)==null?void 0:u.page_icon)||null})}return s}async searchCollections(t="",n=this.user.spaces[0].id){let a=await this.agent.search({type:"BlocksInSpace",query:t,spaceId:n,limit:20,filters:{isDeletedOnly:!1,excludeTemplates:!0,isNavigableOnly:!1,navigableBlockContentOnly:!0,requireEditPermissions:!1,includePublicPagesWithoutExplicitAccess:!1,ancestors:[],createdBy:[],editedBy:[],lastEditedTime:{},createdTime:{},inTeams:[]},sort:{field:"relevance"},source:"quick_find_input_change",searchExperimentOverrides:{},searchSessionId:de(),searchSessionFlowNumber:1,recentPagesForBoosting:[]}),i=[],o=[];for(let s in a.recordMap.block){let c=a.recordMap.block[s].value;c.type=="page"&&(c.parents=Gn(a.recordMap,c.parent_id,c.parent_table),o.push(c))}for(let s in a.recordMap.collection||{}){let c=a.recordMap.collection[s].value;c.parents=Gn(a.recordMap,c.parent_id,"block"),i.push(c)}return{collections:i,pages:o,query:t}}async _submitTransaction(t){return this.agent.submitTransaction({requestId:R(),transactions:[{id:R(),operations:t}]})}async appendBulletPointToPage(t,n,a,i){const o=R();t=dt(t);const s={[F.bullet]:{type:"bulleted_list"},[F.code]:{type:"code",properties:{language:[["Plain Text"]]}},[F.quote]:{type:"quote"}},c=[{id:o,table:"block",path:[],command:"update",args:pa([{type:"bulleted_list",id:o,parent_id:t,parent_table:"block",alive:!0,version:1,created_time:Date.now(),last_edited_time:Date.now(),properties:{title:[[n]]}},s[i]])},{table:"block",id:t,path:["content"],command:a?"listAfter":"listBefore",args:{...a?{after:a}:{},id:o}}];return await this._submitTransaction(c),o}async getSpacePersons({spaceId:t}){return new He({token:this.authToken,activeUserId:this.agent.activeUserId}).custom.getSpacePersons({spaceId:t})}}function Kn(e,t,n){return ke?new Promise(a=>{chrome.tabs.sendMessage(n,{v2:!0,destination:"toast",event:e,props:t},i=>{a(i)})}):new Promise(a=>{chrome.runtime.sendMessage({v2:!0,destination:"toast",event:e,props:t},i=>{a(i)})})}async function fs(e,{notionClient:t}){try{const n=await(e.type=="collection"?t.custom.getCollection({collectionId:e.id,parentCollectionId:e.parentId}):t.custom.getPage({pageId:e.id}));return n.value?{success:!0,item:n.value}:{success:!1}}catch(n){return console.error(n),{success:!1}}}const ms="📝";async function ys(e,{notionClient:t,log:n,db:a}){}function Qt(e){var t,n;return(n=(t=e==null?void 0:e.format)==null?void 0:t.collection_mode)==null?void 0:n.root_page_pointer}function Ua(e){var a,i,o;if(!e)return!1;const t=e.type=="collection"&&((a=e==null?void 0:e.format)==null?void 0:a.app_config_uri)=="notion://wiki_collection",n=t&&((o=(i=e.format)==null?void 0:i.collection_mode)==null?void 0:o.type)=="page_tree"&&Qt(e)!=null;return t&&n}function ws(e,{notionParent:t,capturedWebpage:n,notionClient:a,activeUserId:i,savingAs:o}){var p;let s=e;const c=((p=s.caption)==null?void 0:p.length)>0,u=n.savingTo=="collection";let d=u?`"${s.text}"${c?` — ${s.caption}`:""}`:s.text;return{...t,text:d,blockFormat:u?"page":s.highlightFormat??F.bullet,...s.highlightColor&&!u?{blockColor:s.highlightColor}:{},afterId:n.notionListAfterId,notionSpaceId:n.notionSpaceId,userId:i,extraOperationsFn:!u&&c?({newBlockId:f,operations:g})=>a.custom.addBlockGetOperations({notionParentId:f,text:`${ms} ${s.caption}`,blockFormat:F.bullet,notionSpaceId:n.notionSpaceId,userId:i,blockColor:"gray"}).operations:void 0}}function bs(e,{capturedWebpage:t}){var n,a;return t.savingTo=="page"&&((a=(n=e==null?void 0:e.properties)==null?void 0:n.content)==null?void 0:a.content)!=null}function _s(e,{notionParent:t,capturedWebpage:n,activeUserId:a,page:i,savingAs:o}){return{...t,text:e.note,blockFormat:o,afterId:n.notionListAfterId,notionSpaceId:n.notionSpaceId,userId:a,properties:{}}}function vs(e,{notionParent:t,capturedWebpage:n,activeUserId:a,savingAs:i}){var o;return{...t,text:e.url?[["[🔗 link]",[["a",e.url]]],[` — ${((o=e.name)==null?void 0:o.trim())??"Untitled"}`]]:e.name,blockFormat:i,afterId:n.notionListAfterId,notionSpaceId:n.notionSpaceId,userId:a,properties:{}}}function Is(e,t){return{...e.type=="screenshot"?vs(e,t):e.type=="highlight"?ws(e,t):_s(e,t),isSubpage:Ua(t.page)||t.capturedWebpage.savingTo=="page"&&t.savingAs=="page"}}function ks(e){var t,n;return Ua(e.page)?{notionParentId:(t=Qt(e.page))==null?void 0:t.id,notionParentTable:(n=Qt(e.page))==null?void 0:n.table}:e.capturedWebpage.savingTo=="page"?{notionParentId:e.capturedWebpage.notionPageId,notionParentTable:"block"}:{notionParentId:e.capturedWebpage.notionCollectionId,notionParentTable:"collection"}}function Cs(e,t){return t.savingAs=="page"?`https://notion.so/${zt(e)}`:`https://notion.so/${zt(t.capturedWebpage.notionPageId)}#${zt(e)}`}function Ss(e){const t=e.match(/^(https:\/\/pbs\.twimg\.com\/media\/\w+)(\?format=(jpg|png).*)$/);return t?t[1]+`.${t[3]}`+t[2]:e}function Ts(e){return e.split("/").pop().split("#")[0].split("?")[0]}function Wt(e){let t=typeof e=="string"?new Date(e):e;return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}function Qn(e){return typeof e=="object"&&e!=null&&"hasTime"in e}function Ps(e){if(Array.isArray(e))if(e.some(Qn)){const[t,n]=e;return{type:"datetimerange",start_date:ue(t.date),start_time:Wt(t.date),end_date:ue(n.date),end_time:Wt(n.date),time_zone:t.timezone}}else return{type:"daterange",start_date:ue(e[0]),end_date:ue(e[1])};else if(Qn(e)){const t=e;return{type:"datetime",start_date:ue(t.date),start_time:Wt(t.date),time_zone:t.timezone}}else return{type:"date",start_date:ue(e)}}function Jn(e){var n,a,i,o,s,c,u,d,p,f;const t=Object.keys(e)[0];switch(t){case"image":{let g=e[t];return((a=(n=g==null?void 0:g.items)==null?void 0:n[0])==null?void 0:a.imgUrl)??void 0}case"file":{let g=e[t];if(g.items.length==0)return;let m=[];return g.items.forEach((b,v)=>{let _=b.name??Ts(b.imgUrl).trim();m.push([`${_.length?_:"file"}`,[["a",b.imgUrl]]]),v+1<g.items.length&&m.push([","])}),m}case"select":return[[((o=(i=e[t].items)==null?void 0:i[0])==null?void 0:o.value)??""]];case"status":return[[((c=(s=e[t].items)==null?void 0:s[0])==null?void 0:c.value)??""]];case"multi_select":return[[((d=(u=e[t].items)==null?void 0:u.map(m=>m.value))==null?void 0:d.join(","))??""]];case"relation":{let g=e[t];return Wn((p=g.items)==null?void 0:p.map(m=>m.id),"relation")}case"person":{let g=e[t];return Wn((f=g.items)==null?void 0:f.map(m=>m.id),"person")}case"date":{let g=e[t];if(g==null)return[];const m=Ps(g);return[[rn,[["d",m]]]]}case"url":return[[e[t]??""]];case"text":return[[e[t]??""]];case"title":return[[e[t]??""]];case"email":return[[e[t]??""]];case"phone_number":return[[e[t]??""]];case"number":return[[e[t]??""]];case"checkbox":return[[e[t]?"Yes":"No"]]}}const Rt={icon:"page_icon",pageIcon:"page_icon",pageCover:"page_cover"};function xs(e){return Object.entries(e??{}).flatMap(([n,a])=>{var o,s;const i=Object.keys(a)[0];return i=="template"?a.template.fileIds||[]:i=="file"||i=="image"?((s=(o=a[i])==null?void 0:o.items)==null?void 0:s.filter(c=>c.fileId!=null).map(c=>c.fileId))??[]:[]})}function Oa(e){e.withChildren={content:[],contentBlocks:[]}}function Es(e){const t={large:{width:672,height:380},normal:{width:672,height:250},small:{width:336,height:175}};if(e.type=="fitImage")return u();const n=t[e.size].width,a=t[e.size].height;let i=null,o=null,s=!1,c=!1;switch(e.type){case"coverLike":e.size=="large"&&(c=!0),i=e.width,o=e.height,i!=n&&(o=Math.floor(o*(n/i)),i=n),o>a&&(i=Math.floor(i*(a/o)),o=a),i<n&&(c=!1),o=null;break;case"fullWidthCover":s=!0,o=a;break}return{format:{block_height:o,block_width:i,block_full_width:s,block_page_width:c}};function u(){return!e.width||!e.height?{format:{block_height:null,block_width:720,block_full_width:!1,block_page_width:!0}}:(e.width,e.height,e.width>=t.normal.width?{format:{block_full_width:!0,block_page_width:!1}}:{format:{block_width:e.width,block_full_width:!1,block_page_width:!1}})}}async function Us(e,t,n){const a=Ss(e.imgUrl),i=e.caption,o=e.fileId;o&&(e.fileId=null),t.withChildren||Oa(t);const s=de();t.withChildren.content.push(s),t.withChildren.contentBlocks.push({role:"reader",value:{id:s,version:1,type:e.isNonImage?"file":"image",properties:{source:[[a]],...i?{caption:[[i]]}:{},...e.byteSize?{size:[[e.byteSize]]}:{}},...o?{file_ids:[o]}:{},alive:!0,created_time:Date.now(),last_edited_time:Date.now(),created_by_table:"notion_user",created_by_id:n.activeUserId,last_edited_by_table:"notion_user",last_edited_by_id:n.activeUserId,space_id:n.capturedWebpage.notionSpaceId,...e.isNonImage?{}:Es({type:"fitImage",size:"normal",width:e.width,height:e.height})}})}function Os(e){return Object.values(e).find(t=>t.value.type=="page")||Object.values(e).find(t=>t.value.type=="callout")||Object.values(e)[0]}const Ht={pageFrontImage:(e,t,n)=>{const a=e.image;a.items.length!=0&&a.items.forEach(i=>{Us(i,t,n)})},template:(e,t,n)=>{if(!e.template)return;t.withCallback=async o=>{await n.notionClient.custom.createAsyncTaskToCopyTemplateContent({templateId:e.template.id,targetPageId:o,currentUserId:n.activeUserId,spaceId:n.spaceId})};let a=e.template.properties??{},i=e.template.format??{};t.format={...i,...t.format},t.properties={...te(a,"title"),...t.properties}},content:(e,t,n)=>{if(!e.content)return;t.withChildren||Oa(t),e.content.notionOutput?a(e.content.notionOutput,!0):e.content.type=="list"&&e.content.items.forEach(o=>{a(o.notionOutput,!0)});function a(o,s){const c=i(o,n),u=Os(c),d=Object.values(te(c,u.value.id));u.value.type!="page"?s&&u.value.type=="text"?(t.withChildren.content.push(u.value.id,...u.value.content),t.withChildren.contentBlocks.push({...u,value:te(u.value,"content")},...d)):(t.withChildren.content.push(u.value.id),t.withChildren.contentBlocks.push(u,...d)):(t.withChildren.content.push(...u.value.content),t.withChildren.contentBlocks.push(...d))}function i(o,s){return Object.fromEntries(Object.entries(o).map(([c,u])=>[c,u!=null&&u.value?{...u,value:{...u.value,space_id:s.spaceId,created_by_id:s.activeUserId,last_edited_by_id:s.activeUserId}}:u]))}}};function As(e,t,n){const a=Object.entries(t??{}),i=a.filter(([p,f])=>p in Rt).map(([p,f])=>[Rt[p],Jn(f)]).filter(([p,f])=>f!=null),o=a.filter(([p,f])=>p in Ht).map(([p,f])=>[p,f]),s={...Object.fromEntries(i),...Object.fromEntries(o)},c=a.filter(([p,f])=>!(p in s||p in Ht||p in Rt)).map(([p,f])=>[p,Jn(f)]).filter(([p,f])=>f!=null),u=xs(t),d={properties:Object.fromEntries(c),format:Object.fromEntries(i),...u.length>0?{fileIds:u}:{}};return o.forEach(([p,f])=>{Ht[p](f,d,n)}),d}function Ms(e,t,n){const a=As(e,t,n);ft(e,a)}async function js(e){return e.context.notionClient.custom.uploadFile({dataB64:e.dataB64,name:e.name,record:e.record,onProgress:t=>{e.onProgress(t)}})}async function Fs({properties:e,record:t,context:n}){const a=Object.entries(e??{}).flatMap(([o,s])=>{var u,d,p,f;if(Ds(s)&&((d=(u=s.content)==null?void 0:u.imageItems)!=null&&d.length))return s.content.imageItems.map((m,b)=>({propertyId:o,item:m,index:b})).filter(({item:m,index:b})=>m.needToUploadFile);if(!$s(s))return[];const c=(f=(p=s[Object.keys(s)[0]])==null?void 0:p.items)==null?void 0:f.map((g,m)=>({item:g,index:m})).filter(({item:g,index:m})=>g.needToUploadFile);return!c||!c.length?[]:c.map(({item:g,index:m})=>({propertyId:o,item:g,index:m}))});let i=0;for(const{propertyId:o,item:s,index:c}of a){n.updateProgressToast({message:`Uploading ${i+1}/${a.length} file${a.length>1?"s":""}...`});const u=await js({dataB64:s.imgUrl,name:s.name,record:t,onProgress:f=>{n.updateProgressToast({message:`Uploading ${i+1}/${a.length} file${a.length>1?"s":""}...`})},context:n});if(u==null||u.success==!1)throw new Error("failed to upload file");const d=e[o],p=Object.keys(d)[0];if(p=="content"){let f=function(m){const b=m==null?void 0:m[g.imageItems[c].notionId];b&&(m[g.imageItems[c].notionId]={...b,value:{...b.value,properties:{...b.value.properties,source:[[u.url]]},...u.fileId?{file_ids:[u.fileId]}:{},format:{...b.value.format,block_page_width:!0,block_full_width:!1}}})};const g=d[p];g.imageItems[c].needToUploadFile=!1,g.imageItems[c]={...g.imageItems[c],needToUploadFile:!1,fileId:u.fileId,imgUrl:u.url},g.type=="list"?g.items.forEach(m=>{f(m.notionOutput)}):f(g.notionOutput)}else{const f=d[p];f.items[c].needToUploadFile=!1,f.items[c]={...f.items[c],needToUploadFile:!1,fileId:u.fileId,imgUrl:u.url}}i+=1}}function $s(e){return(e==null?void 0:e.image)!=null||(e==null?void 0:e.file)!=null}function Ds(e){return(e==null?void 0:e.content)!=null}async function Aa(e,{notionClient:t,page:n,log:a,db:i,updateToast:o,highlightContextData:s}){var C;a("load user...");const c=e.highlight,u=await i.user.load();a("load capturedWebpage...");const d=await i.capturedWebpage.get(c.capturedWebpageId);let p,f=u.settings.highlightFormat??F.bullet;const g={capturedWebpage:d,activeUserId:t.activeUserId,spaceId:d.notionSpaceId,page:n,notionParent:ks({capturedWebpage:d,page:n}),notionClient:t,savingAs:d.savingTo=="collection"||bs(c,{capturedWebpage:d})?"page":F.bullet,updateProgressToast:async j=>o({id:c.id,type:"progress",message:j.message}),updateHighlight:async j=>{}};let m=c.properties;c.type=="screenshot"&&(m={...m,pageFrontImage:{image:{items:[{imgUrl:(C=s==null?void 0:s.image)==null?void 0:C.imageBase64,needToUploadFile:!0,...c.caption&&{caption:c.caption}}]}}});const b=Is(c,g);if(await Fs({properties:m,record:{id:b.notionParentId,table:b.notionParentTable,spaceId:b.notionSpaceId},context:g}),a("save highlight... in database"),Ms(b,m,g),await o({id:c.id,type:"progress",message:"Saving to Notion..."}),p=await t.custom.addBlock(b),p==null)throw new Error("Failed to save to Notion");a("‣ save highlight in database");const _={...await i.highlight.get(c.id),notionBlockId:p,notionBlockFormat:f};await i.highlight.save(c.id,te(_,"properties")),a("update capturedWebpage.listAfter in database"),await i.capturedWebpage.save(d.id,{...d,notionListAfterId:p});const k=Cs(p,g);return await o({id:c.id,type:"success",message:"Saved to Notion!",action:{url:k,message:"Open in Notion"},timeout:4e3}),a("success!"),{notionBlockId:p,notionBlockFormat:b.blockFormat,title:b.text,notionParentId:b.notionParentId,savingAs:g.savingAs}}function zt(e){return e.replace(/-/g,"")}async function Bs(e,{notionClient:t,log:n,db:a}){const i=await a.capturedWebpage.get(e.capturedWebpageId),o=await a.highlight.get(e.highlightId);n("remove block from Notion"),await t.custom.removeBlock({notionParentId:i.notionPageId,notionBlockId:o.notionBlockId,notionSpaceId:i.notionSpaceId}),n("remove highlight from local database"),await a.highlight.delete(o.id),await a.capturedWebpage.save(i.id,{...i,highlights:i.highlights.filter(s=>s!=o.id)})}async function Ls(e,{notionClient:t,log:n,db:a}){const i=await a.capturedWebpage.get(e.capturedWebpageId),o=await a.highlight.get(e.highlightId);o.notionCaptionBlockId?(n("remove caption block from Notion"),await t.custom.removeBlock({notionParentId:o.notionBlockId,notionBlockId:o.notionCaptionBlockId,notionSpaceId:i.notionSpaceId})):n("no need to delete caption on Notion"),await a.highlight.save(e.highlightId,{...o,caption:null,notionCaptionBlockId:null,showCaption:!1})}const Ns=Object.freeze(Object.defineProperty({__proto__:null,addHighlight:Aa,removeCaptionHighlight:Ls,removeHighlight:Bs,updateCaptionHighlight:ys},Symbol.toStringTag,{value:"Module"}));class Ws extends Ro{constructor(){super(...arguments),this.name="NoEventException",this.errorMsg="event not implemented yet"}}class Rs{constructor(){this.concurrency=1,this.running=0,this.taskQueue=[],this.runTask=t=>{this.running++,t(n=>{this.running--,this.taskQueue.length>0&&this.runTask(this.taskQueue.shift())})},this.enqueueTask=t=>this.taskQueue.push(t),this.push=t=>this.running<this.concurrency?this.runTask(t):this.enqueueTask(t)}}class Hs{constructor(){this.queue=new Rs,w.notionSync.load().then(t=>this.notionSync=t)}async addEvent(t){const n={...t,_eventId:Yt(10)};return this.notionSync.pendingEvents.push(n),await w.notionSync.save(this.notionSync),chrome.runtime.sendMessage({popup:{name:"notionSyncPendingEvent",args:n}}),this.queue.push(async a=>{await this.processEvent(n),this.notionSync.pendingEvents=this.notionSync.pendingEvents.filter(i=>i._eventId!==n._eventId),await w.notionSync.save(this.notionSync),chrome.runtime.sendMessage({popup:{name:"notionSyncCompletedEvent",args:n}}),a()}),!0}async processEvent(t){try{const n=await ze(),a={notionClient:n,log:o=>ne(o),db:w,updateToast:V.updateAndShowToastEvent};ne("start processing EVENT",t.type);const i=Ns[t.type];if(!i)throw new Ws;return t.activeUserId&&(n.activeUserId=t.activeUserId),await i(t,a),!0}catch(n){const a=n;return console.error(a),{errorName:a.name,errorMsg:a==null?void 0:a.errorMsg}}}}const Ma=new Hs,zs={addNotionSyncEvent:async e=>{await Ma.addEvent(e.event)}};function Vs(e){return Ma.addEvent(e)}async function ja(e){const t=await w.urlToCapturedWebpage.get(e);return t?await w.capturedWebpage.get(t.capturedWebpageId):null}async function Fa(e=null,t){await re({__action:"findHighlight",__highlights:e,__highlightId:t||null}),await Ce("highlightSelection.js")}async function qs(){return await re({__action:"getSelectionRangeRepresentation",__highlights:null,__highlightId:null}),await Ce("highlightSelection.js")}async function Gs(e){return await re({__action:"removeSelection",__highlights:null,__highlightId:e}),await Ce("highlightSelection.js")}async function Be(e,t,n){await To(null,n)}async function $a(e){return Be("initFloating",void 0,e)}async function Ks(e,t,n){const a=kt();Po({idName:a,popupUrl:ha(),action:e,props:t},n)}const Yn="Save to Notion cannot be used on the current page, please try on a different page.",Qs=["chrome://","https://chrome.google.com/","https://www.homedepot.com"];async function Da(e){if(Qs.some(t=>e.url.startsWith(t))||e.url==""){alert(Yn);return}try{Pe("open",e.id)}catch{alert(Yn)}}function Js(e,t={timeout:7e3,interval:1e3}){return new Promise(async(n,a)=>{const i=Date.now();if(await e())return n(!0);const o=setInterval(async()=>{await Ys(e)?(clearInterval(o),n(!0)):Date.now()-i>t.timeout&&(clearInterval(o),a(new Error("Timeout")))},t.interval)})}async function Ys(e){let t;try{t=await e()}catch(n){console.error(n),t=!1}return t}async function Xs(e){await ko("__stnModule",e)||await Ee("content/content.js",e)}function Zs(e,t){return e==-1&&!(t!=null&&t.url)}async function Ba(e,t,n,a){var m,b;let i,o;try{if(n!=null&&n.endsWith(".pdf"))i={pageUrl:n,selectionText:t};else if(i=await Ce("getSelectedText.js"),o=await qs(),(!i.selectionText||i.selectionText.length==0)&&a&&i.pageUrl.endsWith(".pdf")){alert("The shortcut for PDF highlighting is temporarily disabled. Please use the right-click context menu instead. We apologize for any inconvenience.");return}}catch{const _=await ae();i={pageUrl:(_==null?void 0:_.url)??n,selectionText:t}}const s=qe(i.pageUrl),c=await ja(s),u=await w.user.load(),d=((m=u==null?void 0:u.settings)==null?void 0:m.highlightFormat)||F.bullet,p=((b=u==null?void 0:u.settings)==null?void 0:b.highlightColor)||"default";await w.captureContext.save({type:"highlight",highlightContextData:{text:i.selectionText,highlightFormat:d,highlightColor:p,selectionRange:o,capturedWebpage:c}});let f;e==-1&&(f=await ae());let g=e==-1?f==null?void 0:f.id:e;if(Zs(e,f)){alert("To highlight in PDFs, first open the clipper. This workaround addresses a known bug we're actively fixing. Thank you for your patience.");return}await Te(g)}async function Jt(e){await $a(e)}async function Te(e){console.log("1/3 loaded..."),$a(e),console.log("2/3 loaded..."),await Ne(10);let t=0;console.log("2/3 loaded..."),await Js(async()=>(console.log("waiting for ping",t++),await Promise.race([(async()=>(await Ne(20),console.log("failed"),!1))(),oe("ping",void 0,e)]).then(n=>n)),{timeout:7e3,interval:20}),await oe("showModal",void 0,e)}async function La(e){await Xs(e),await oe("startWatch",await w.quickCapture.load())}async function ec(){return new Promise(e=>{chrome.tabs.query({},async t=>{await Promise.all(t.map(async n=>{await oe("stopWatch",void 0,n.id)})),await e(void 0)})})}function tc(e){let t=typeof e=="string"?new Date(e):e;var n=new Date(t.getTime()),a=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1).padStart(2,"0"),o=n.getFullYear();const s=String(n.getMinutes()).padStart(2,"0"),c=String(n.getHours()).padStart(2,"0");return o+"-"+i+"-"+a+" "+c+":"+s}async function _t(e,t,n){const a=await Le(e);if(!a.success)return;const i=qe(n),o=await ja(i);await w.captureContext.save({type:"highlight",highlightContextData:{type:"image",text:`New Screenshot ${tc(new Date)}`,image:{imageBase64:a.imageBase64},url:n,capturedWebpage:o}}),await Te(t)}async function nc(e,t){const n=t==null?void 0:t.url;return e.menuItemId=="stn_save_page"?Da(t):e.menuItemId=="stn_take_full_page_screenshot"?_t("takeScreenshot",t==null?void 0:t.id,n):e.menuItemId=="stn_select_zone_screenshot"?_t("capturePortion",t==null?void 0:t.id,n):Ba(t.id,e.selectionText,e==null?void 0:e.frameUrl)}async function ac(e,t){const n=t==null?void 0:t.url;if(e=="take-full-page-screenshot")return _t("takeScreenshot",t==null?void 0:t.id,n);if(e=="take-custom-area-screenshot")return _t("capturePortion",t==null?void 0:t.id,n);Ba((await ae()).id,void 0,void 0,!0)}function ic(){vt.setBadgeText({text:"✓"}),vt.setBadgeBackgroundColor({color:"#BBF7D0"})}function Na(){vt.setBadgeText({text:""})}async function Tt(e){const t=e||await ae();if(!(t!=null&&t.url))return;const n=t.url&&qe(t.url);if(await w.urlToCapturedWebpage.get(n))ic();else{Na();return}}async function oc(){await ln()&&await Tt()}function Wa(e,t,n){t.status=="complete"&&n.active&&Tt(n)}function Ra(e){Tt()}function rc(){chrome.tabs.onUpdated.removeListener(Wa),chrome.tabs.onActivated.removeListener(Ra),Na(),chrome.permissions.remove({permissions:["tabs"]})}function Ha(){chrome.tabs.onUpdated.addListener(Wa),chrome.tabs.onActivated.addListener(Ra),Tt()}function ln(){return new Promise(e=>{chrome.permissions.contains({permissions:["tabs"]},t=>{e(t)})})}function sc(){return new Promise(e=>{chrome.permissions.request({permissions:["tabs"]},t=>{e(t)})})}function un(){return new Promise(e=>{chrome.permissions.contains({origins:["<all_urls>"],permissions:["tabs"]},t=>{e(t)})})}function za(){return new Promise(e=>{chrome.permissions.request({origins:["<all_urls>"],permissions:["tabs"]},t=>{e(t)})})}async function cc(){return await un()?(await w.quickCapture.load()).enabled:!1}let Vt={};function Va(e){Vt[e]||(Vt[e]=setTimeout(async()=>{await La(e),Vt[e]=null},20))}function qa(e,t,n){t.status=="loading"&&n.active&&setTimeout(()=>Va(e),100)}function Ga(e){Va(e.tabId)}function dn(){chrome.tabs.onUpdated.addListener(qa),chrome.tabs.onActivated.addListener(Ga)}async function Ka(){chrome.tabs.onUpdated.removeListener(qa),chrome.tabs.onActivated.removeListener(Ga),await ec()}async function qt(e,t){}function lc(e,t){return e.length>t?`${e.substring(0,t)}...`:e}async function Le(e,t){const n=await new Promise(a=>Zt("screenshot.js",a,{type:e,...t}));return n.success==!1?{success:!1}:n}async function uc(e,t,n){return await new Promise(i=>xo("clipContent.js",i,{action:e,props:t},n))}async function dc(e){return await new Promise(n=>Zt("scanWebpage.js",n,{},e))}function pc(e){try{const t=new URL(e);return{hostname:t.hostname,url:e,pathname:t.pathname}}catch{return null}}const pt={popupAsk:null};function gc(e,t){return new Promise(n=>{chrome.permissions.contains({...e?{origins:[e]}:{},permissions:t},a=>{n(a)})})}async function Xn(e){if(ke)return!0;const t=await gc("<all_urls>",["tabs"]);let n;if(t)n=!0;else return await Jt(e),await oe("showDownloadRemoteImagePermissionsAlert",{},e);return n}function hc(e){const t=new FileReader;return t.readAsDataURL(e),new Promise(n=>{t.onloadend=()=>{const a=t.result;if(!a)throw new Error("incorrect image");const i=typeof a=="string"?a:new TextDecoder("utf-8").decode(a);n(i)}})}async function Qa({url:e}){const t=await fetch(e);return t.ok?{ok:!0,b64:await hc(await t.blob())}:{ok:!1}}function fc(e){return`https://images.weserv.nl/?url=${encodeURIComponent(e)}`}function mc(e){return e.length*.75-(e.endsWith("==")?2:e.endsWith("=")?1:0)>5e5}async function yc(e){const t=await Qa({url:e});return t.ok?t.b64:null}async function wc(e){return e==null?{success:!1}:{success:!0,imageBase64:e}}function Zn(e,t){return new Promise(n=>{chrome.permissions.contains({...e?{origins:[e]}:{},permissions:t},a=>{a?n(!0):chrome.permissions.request({...e?{origins:[e]}:{},permissions:t},i=>{n(i)})})})}let ea={pendingImgUrl:null};const V={closeAndLogin:async(e,t)=>{var n;await Pe("closeAndLogin",(n=t.tab)==null?void 0:n.id,void 0)},iframeAsk:async({url:e,event:t,properties:n},a)=>{const o=a.tab.id,s=e;if(!await Zn("https://*.licdn.com/*",["webNavigation","tabs"]))return null;const u=await new Promise(d=>{chrome.webNavigation.getAllFrames({tabId:o},p=>{console.debug("frames",p);const f=p.find(g=>g.url==s);d(f?f.frameId:null)})});return console.debug("frameId",u),u?(console.debug("insert content"),await Co({filename:"content/content.js",tabId:o,frameId:u}),console.debug("inserted content, now getting image"),await _o("getCarouselImages",{},{tabId:o,frameId:u})):null},contentAsk:async({event:e,props:t},n)=>{try{await Jt(n.tab.id)}catch(i){console.debug(i)}const a=await oe(e,t,n.tab.id);return console.debug("contentAsk -> response",a),a},popupExchange:(e,t,{onProgress:n})=>(console.log("popupExchange starting..."),new Promise(a=>{pt.popupAsk=(i,o)=>{n({fromBackground:!0,popup:{name:i,args:o}})}})),hasNotionCookie:async()=>{const e=await chrome.cookies.get({url:"https://www.notion.so",name:"token_v2"});return(e==null?void 0:e.value)!=null},resizeClipper:(e,t)=>{var n;return Pe({action:"resize",width:e.width,height:e.height},(n=t==null?void 0:t.tab)==null?void 0:n.id)},updateImageEditorConfig:async e=>{await w.imageEditorConfig.save(e.config)},loadImageConfig:async()=>w.imageEditorConfig.load(),editContent:async(e,t)=>{await w.captureContext.save({type:"content",contentContextData:{content:e.content}}),await Te(t.tab.id)},getPendingBigImage:async()=>ea.pendingImgUrl,editImage:async(e,t)=>{const n=await w.imageEditorConfig.load();let a=mc(e.imgUrl);console.log("imageIsAbove1mb",a,e.imgUrl.length),await w.captureContext.save({type:"image",imageContextData:{imgUrl:a?"pending_big_image":e.imgUrl,config:n}}),a&&(ea.pendingImgUrl=e.imgUrl),console.log("opening..."),await Te(t.tab.id),console.log("done!")},getPageMetadata:(e,t)=>en(t.tab),getInfoFromCurrentPage:async(e,t)=>{var a;const n=pc((a=t==null?void 0:t.tab)==null?void 0:a.url);return n?{url:t.tab.url,title:t.tab.title,...n}:null},ping:async()=>{const e=await chrome.permissions.contains({permissions:["cookies"],origins:["https://*.notion.so/*"]});try{const t=await(await fetch("https://www.notion.so/api/v3/loadUserContent",{method:"POST",headers:{accept:"*/*","accept-language":"en-US,en;q=0.9","content-type":"application/json"}})).json();return{out:[await chrome.cookies.get({url:"http://www.notion.so/",name:"token_v2"}),await chrome.cookies.get({url:"https://www.google.com/",name:"DV"}),await chrome.cookies.get({url:"https://notion.so/",name:"_cioid"}),await chrome.cookies.get({url:"https://www.notion.so/",name:"_cioid"}),await chrome.cookies.get({url:"https://www.notion.so/",name:"token_v2"}),await chrome.cookies.get({url:"https://toto.www.notion.so/",name:"token_v2"}),await chrome.cookies.get({url:"https://notion.so/",name:"token_v2"}),await chrome.cookies.get({url:"https://notion.so/",name:"_rdt_uuid"}),await chrome.cookies.get({url:"https://www.notion.so/",name:"NEXT_LOCALE"}),await chrome.cookies.get({url:"https://www.notion.so/",name:"notion_check_cookie_consent"}),await chrome.cookies.get({url:"http://notion.so/",name:"_cfuvid"}),await chrome.cookies.get({url:"http://www.notion.so/",name:"_cfuvid"}),await chrome.cookies.get({url:"http://www.notion.so/",name:"token_v2"})],x:e,r3:t,resp:!0}}catch(t){return{error:t.toString(),resp:!1}}},showListButton:async(e,t)=>{var n;await Pe("showListButton",(n=t.tab)==null?void 0:n.id,void 0)},extractListItems:(e,t)=>{var n;return uc("pickList",null,(n=t.tab)==null?void 0:n.id)},captureVisibleTab:async(e,t)=>new Promise((n,a)=>{chrome.tabs.captureVisibleTab(t.tab.windowId,{format:"png"},i=>{chrome.runtime.lastError?a(chrome.runtime.lastError.message):n(i)})}),takeFullPageScreenshot:()=>Le("takeScreenshot"),takeFullScreenScreenshot:()=>Le("takeFullScreenshot"),takeCustomAreaScreenshot:()=>Le("capturePortion"),pickImageOnPage:()=>Le("selectImage"),downloadRemoteImage:async({url:e},t)=>{const n=await Xn(t.tab.id);return wc(await yc(n?e:fc(e)))},askPermsToDownloadRemoteImage:async(e,t)=>await Xn(t.tab.id),askDirectPermsToDownloadRemoteImages:async(e,t)=>ke?!0:await Zn("<all_urls>",["tabs"]),addTelemetryEvent:kc,trackEvent:Cc,scanWebpage:(e,t)=>{var n;return dc((n=t.tab)==null?void 0:n.id)},removeContextMenuRightClick:async()=>{await chrome.contextMenus.remove("stn_save_page"),await chrome.contextMenus.remove("stn_take_full_page_screenshot"),await chrome.contextMenus.remove("stn_select_zone_screenshot")},fetch:async({url:e,opts:t})=>{const n=await fetch(e,t),a=n.json();return{status:n.status,json:a}},fetchB64:Qa,addContextMenuRightClick:async()=>{Za()},updateAndShowToastEvent:async e=>{const t=await w.toastSession.load();let n=t.events.filter(i=>{if(!i.expiration)return!1;const o=i.expiration;return!(new Date(i.createdAt).getTime()+o<Date.now())});const a=e.id?t.events.findIndex(i=>i.id==e.id):-1;a!=-1?n=n.map((i,o)=>o==a?{...i,...e}:i):n=[...n,{...e,createdAt:new Date().toISOString(),expiration:1e4}],await w.toastSession.save({events:n}),await oe("showToast",void 0),Ne(10).then(async()=>{const i=await ae();await Kn("updateToastEvent",e,i.id)})},removeToastEvent:async(e,t)=>{const a=(await w.toastSession.load()).events.filter(i=>i.id!=e.id);await w.toastSession.save({events:a}),await Kn("removeToastEvent",e,t.tab.id)},closeToast:async()=>{await oe("closeToast",void 0)},notionLoadElement:async e=>{const t=await ze(e.userId);return fs(e,{notionClient:t,log:null,db:w})},syncNotionPage:async e=>{const t=await ct({});if(!t)return{errorCode:"notionSessionExpired"};const n=Gt(e.spaceId,t.notionContext);if(!n&&!Gt(e.spaceId,await V.refreshNotionContext(void 0)))return{errorCode:"noSpaceAccessGranted"};const a=await V.notionLoadElement({id:e.pageId,type:e.type,parentId:e.parentId,userId:n});if(!a.success){const i=await V.refreshNotionContext(void 0);return i?Gt(e.spaceId,i)?{errorCode:"noPageReadAccessGranted"}:{errorCode:"noSpaceAccessGranted"}:{errorCode:"notionSessionExpired"}}return{syncPage:a.item}},loadGmail:async(e,t)=>(await Jt(t.tab.id),await oe("loadGmail",e,t.tab.id)),openFeedbackModal:async({context:e},t)=>{await w.captureContext.save({type:"feedback",feedbackContextData:e}),await Te(t.tab.id)},openImageModal:async({context:e},t)=>{},addFeedback:na,tryQuickCapture:async(e,t)=>{qt(),await Te(t.tab.id)},startCaptureWatch:async(e,t)=>{dn(),await La(t.tab.id)},stopCaptureWatch:async(e,t)=>{await Ka()},askAllUrlsAndTabsPermissions:async()=>za(),checkQuickCaptureFeatureEnabled:async()=>{if(!await un())return{enabled:!1};const t=await w.quickCapture.load();return t||{enabled:!1}},saveImageCache:async e=>{const t=await w.imageCacheInfo.load();if(!t.cachedUrls.find(n=>n===e.imageCache.url)){if(t.cachedUrls.length>=20){const n=t.cachedUrls.shift();await w.imageCaches.remove(n)}t.cachedUrls.push(e.imageCache.url),await w.imageCacheInfo.save(t),await w.imageCaches.save(e.imageCache.url,e.imageCache)}},getImageCache:async e=>await w.imageCaches.get(e.url),loadTooltipSession:async()=>await w.tooltipSession.load(),loadToastSession:async()=>await w.toastSession.load(),openPage:async e=>{chrome.tabs.create({url:e.url})},loadCaptureContext:async()=>{let e=await w.captureContext.load();return e?await w.captureContext.remove():e={type:"note"},e},updateTwitterSession:async e=>{const t=await w.twitterSession.load()||{};await w.twitterSession.save({...t,...e})},getExtensionContext:async e=>({modalUrl:chrome.runtime.getURL("modal/modal.html"),tooltipUrl:chrome.runtime.getURL("tooltip/tooltip.html"),toastUrl:chrome.runtime.getURL("toast/toast.html"),extensionId:chrome.runtime.id}),updateCaptureSession:async e=>{await w.quickCaptureSession.save(e.session)},refreshNotionContext:async()=>{const e=await Ja(),t=await ct({});return await w.quickCaptureSession.save({...t,notionContext:{...t.notionContext||{},...e}}),e},savePersonsInNotionContext:async e=>{const t=await ct({}),n={...t.notionContext,spacePersonsMap:{...t.notionContext.spacePersonsMap??{},[e.spaceId]:{persons:e.persons}}};return await w.quickCaptureSession.save({...t,notionContext:n}),n},setActiveUserId:vc,loadCaptureSession:ct,searchPages:Ya,submitCapture:async(e,t,n)=>{var f,g,m,b,v,_,k,C,j;console.log("submitCapture",e);const a=e.session;if(e.payload.type=="highlight"?qt("save_highlight",{url:e.payload.highlightContextData.url}):e.payload.type=="note"&&qt(),e.payload.type=="highlight"){const S=((f=e.payload.highlightContextData)==null?void 0:f.highlightFormat)||F.bullet,$=((g=e.payload.highlightContextData)==null?void 0:g.highlightColor)||"default",E=await w.user.load(),q=(E==null?void 0:E.settings.highlightFormat)||F.bullet,A=(E==null?void 0:E.settings.highlightColor)||"default";(S!=q||$!=A)&&await w.custom.saveUser({...E,settings:{...E.settings,highlightFormat:S,highlightColor:$}})}const i=a.page.id,o=a.page.type=="collection"?{savingTo:"collection",notionPageId:null,notionCollectionId:a.page.id}:{savingTo:"page",notionPageId:a.page.id,notionCollectionId:null},s=(m=a.notionContext.spacesMap[a.page.spaceId])==null?void 0:m.linkedUserIds[0];let c=await w.capturedWebpage.get(i);c||(c=await w.custom.createCapturedWebpage({notionBookmarkId:null,capturedWebpageId:i,icon:null,url:null,source:"capture",notionListAfterId:null,title:null,formId:null,notionSpaceId:a.page.spaceId,clipFormat:We.bookmark,...o}));const u={id:de(),...e.payload.properties&&{properties:e.payload.properties},capturedWebpageId:c.id,uploadedAt:"",notionBlockId:null,createdAt:new Date().toISOString(),notionUserId:s},d=e.payload.type=="highlight"&&((b=e.payload.highlightContextData)==null?void 0:b.type)=="image",p=await w.custom.createHighlight(e.payload.type=="highlight"&&d?{...u,type:"screenshot",name:e.payload.highlightContextData.text,caption:e.payload.caption,url:e.payload.highlightContextData.url,showCaption:!1}:e.payload.type=="note"?{...u,note:e.payload.note,type:"note",showCaption:!1}:{...u,type:"highlight",text:e.payload.highlightContextData.text,...e.payload.caption.length?{caption:e.payload.caption,showCaption:!0}:{showCaption:!1},selectionRange:e.payload.highlightContextData.selectionRange,highlightFormat:e.payload.highlightContextData.highlightFormat||F.bullet,highlightColor:e.payload.highlightContextData.highlightColor||void 0});if(e.payload.type=="highlight"&&!d&&await Fa([p]),(v=e.context)!=null&&v.executeDirectly)try{const S=await Aa({type:"addHighlight",capturedWebpageId:i,activeUserId:s,highlight:p},{notionContext:a.notionContext,page:a.page,highlightContextData:e.payload.highlightContextData??null,notionPageId:i,notionClient:await ze(s),userId:s,db:w,log:console.log,updateToast:$=>{if(console.log("upload toast",$),n)n==null||n.onProgress($);else return V.updateAndShowToastEvent($)}});if((_=e.context)!=null&&_.url){let $=function(A){return Array.isArray(A)?A.slice(0).map(G=>`${G[0]}`).join("").replace(/^.*?—\s?/g,""):A},E=qe((k=e.context)==null?void 0:k.url);const q={...S.savingAs=="page"?{savingTo:"page",notionPageId:S.notionBlockId,notionCollectionId:S.notionParentId}:{savingTo:"page",notionBookmarkId:S.notionBlockId,notionPageId:S.notionParentId},capturedWebpageId:S.notionBlockId,icon:null,url:E,source:"capture",notionListAfterId:null,title:$(S.title),formId:null,notionSpaceId:a.page.spaceId,clipFormat:We.bookmark};await w.custom.createCapturedWebpage(q)}}catch(S){console.log("fail",S.toString()),console.error(S);const $=_c(S.toString()),E=bc(S,e);return(!ke||!St)&&na({type:"crash",note:`Failed to submit ${JSON.stringify(E,null,2)}`,email:((C=e.context)==null?void 0:C.email)??"unknown",isPro:(j=e.context)==null?void 0:j.isPro,canSubmit:!0}),n?n==null||n.onProgress({id:de(),type:"error",message:$,messageDetailed:JSON.stringify(E,null,2)}):await V.updateAndShowToastEvent({id:de(),type:"error",message:`Failed to capture ${p.type=="highlight"?"highlight":p.type=="screenshot"?"screenshot":"note"}`,action:{message:"Try Again",bgAction:"submitCapture",bgActionProps:e}}),!1}else await Vs({type:"addHighlight",capturedWebpageId:i,activeUserId:s,highlight:p});return!0}};function bc(e,t){return{message:e.message,stack:e.stack,createdAt:new Date().toISOString(),submitProps:t}}function _c(e){let t=lc(`${e}`.split(`
`)[0].trim(),50);return t.includes("Failed to fetch")?"it seems you are not connected to internet, please check your internet connection and try again":t.includes("upload file")?"Failed to upload file. Please try again.":"Failed to upload to Notion. go to notion.so on this browser and ensure you are logged in to the right workspace, then try again with the clipper."}async function ta(e){const t=e.spacesMap[Object.keys(e.spacesMap)[0]];return t?(await Ya({text:"",spaceId:t.id,userId:t.linkedUserIds[0]}))[0]:null}async function ct(e){var n,a;let t=await w.quickCaptureSession.load();if(!t||!t.notionContext){const i=await Ja();if(!i)return null;t=await w.quickCaptureSession.save({page:await ta(i),notionContext:i})}if(!t.page&&!e.skipLoadExamplePage&&(t.page=await ta(t.notionContext),t=await w.quickCaptureSession.save(t)),Sc(e.context)){const i=(a=(n=e.context)==null?void 0:n.highlightContextData)==null?void 0:a.capturedWebpage;t.page={id:i.notionPageId,type:"page",properties:{title:i.title},format:{page_icon:i.icon},spaceId:i.notionSpaceId}}return t}function Gt(e,t){var a;const n=(a=t==null?void 0:t.spacesMap[e])==null?void 0:a.linkedUserIds[0];return n||null}async function vc(e){J.set(It,e)}async function Ja(){try{return await(await ze()).custom.loadNotionContext()}catch(e){return console.error(e),null}}function Kt(e,t,n){var i;return((i=e[n??"block"])==null?void 0:i[t])??null}function Ic(e,{id:t,table:n}){var s,c,u,d,p;let a=[],i=Kt(e,t,n),o=Kt(e,(s=i==null?void 0:i.value)==null?void 0:s.parent_id,(c=i==null?void 0:i.value)==null?void 0:c.parent_table);for(;o!=null&&o.value;)((u=o.value)==null?void 0:u.id)in(e.collection||{})?a.push({name:Re(o.value,"name","Untitled"),icon:((d=o.value.format)==null?void 0:d.page_icon)||null}):o.value.type=="page"&&a.push({name:Re(o.value.properties,"title","Untitled"),icon:((p=o.value.format)==null?void 0:p.page_icon)||null}),o=Kt(e,o.value.parent_id,o.value.parent_table);return a.reverse(),a}async function Ya(e){const n=await(await ze(e.userId)).custom.search(e);return n.results.map(a=>{var o,s,c,u,d,p,f,g,m;const i=(s=(o=n.recordMap.block)==null?void 0:o[a.id])==null?void 0:s.value;return(i==null?void 0:i.type)=="collection_view"||(i==null?void 0:i.type)=="collection_view_page"?{type:"collection",...(f=(p=(c=n.recordMap)==null?void 0:c.collection)==null?void 0:p[(i==null?void 0:i.collection_id)||((d=(u=i.format)==null?void 0:u.collection_pointer)==null?void 0:d.id)])==null?void 0:f.value}:i||((m=(g=n.recordMap.collection)==null?void 0:g[a.id])==null?void 0:m.value)}).filter(a=>a).map(a=>({...a,parents:Ic(n.recordMap,{id:a.id,table:a.type=="collection"?"collection":"block"}),spaceId:e.spaceId}))}async function kc(e){}async function Cc(e){ke||await fetch("https://6kbxs6snzg.execute-api.us-east-1.amazonaws.com/v1/integration/telemetry",{method:"POST",keepalive:!0,headers:{"Content-Type":"application/json"},body:JSON.stringify({event:e.event,properties:e.properties??{}})})}async function na(e){try{return await(await fetch("https://6kbxs6snzg.execute-api.us-east-1.amazonaws.com/v1/integration/feedback",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}})).json()}catch{return{success:!1}}}function Sc(e){var t;return((t=e==null?void 0:e.highlightContextData)==null?void 0:t.capturedWebpage)!=null}async function Xa(e,t=chrome.cookies.get){var o;let n,a;if(St?a={}:a=await ht(t,{url:"https://www.notion.so",name:"token_v2"}),!a)return{status:"error",errorMsg:"need_to_login_to_notion"};a.value;const i=await V.loadCaptureSession({skipLoadExamplePage:!0});return i==null?{status:"error",errorMsg:"need_to_login_to_notion"}:(n=new hs(null),n.user=Qr(i.notionContext),n.agent.activeUserId=await J.get(It,null)??((o=n.user)==null?void 0:o.id),{status:"ok",client:n})}async function Tc(){var e;return St?null:(e=await ht(chrome.cookies.get,{url:"https://www.notion.so",name:"token_v2"}))==null?void 0:e.value}async function ze(e){const[t,n]=await Promise.all([Tc(),J.get(It,null)]),a=new He({token:t,activeUserId:n});return e&&(a.activeUserId=e),a}async function Pc(e,t){console.log("load client v2",e,t);const{status:n,errorMsg:a,client:i}=await Xa();if(console.log("loaded",n,i),n=="error")throw new Error(`incorrect '${e}'`);if(e=="loadPageChunk")return i.agent.loadPageChunk(t[0]);if(e=="loadUserContent")return i.agent.loadUserContent(t[0]);if(!(e in i))throw`incorrect route '${e}'`;return i[e](...t)}async function xc(e){return await re({__save_to_notion_customs:e}),Ce("getCustomCssData.js")}const Ec={asyncExec:async e=>await fe[e.asyncId](e),getTabId:async(e,t)=>t.tab.id,getMetadatas:async(e,t)=>await en(),createNewTab:async(e,t)=>(chrome.tabs.create({url:e.data.url}),null),executeScript:async(e,t)=>(await re({__params:e.params}),await Ce(`${e.name}.js`,t.tab)),executeActionWithResp:async(e,t)=>await gt(a=>{var i,o;return Zt((((i=e.action)==null?void 0:i.action)||e.action)+".js",a,e.extraParams,(o=t==null?void 0:t.tab)==null?void 0:o.id)}),executeAction:async(e,t)=>{var i,o;let n=null;typeof e.action=="object"&&((i=e.action)==null?void 0:i.action)=="closeAndOpenUrl"&&((o=e.action)!=null&&o.url)&&(n=e.action.url,e.action.action="close");const a=t.tab.id;return await Pe(e.action,a,void 0,e.mode),n&&setTimeout(()=>{chrome.tabs.create({url:e.action.url})},200),null},notion:async e=>{try{return{success:!0,data:await Pc(e.cmd,e.params)}}catch(t){return console.error(t),{success:!1,errorMsg:t.toString()}}},chromeCookiesGet:async e=>ht(chrome.cookies.get,e.data),chromeTabsQuery:async e=>ht(chrome.tabs.query,e.data),expandPopup:async e=>{},getDataOnPage:async e=>await xc(e.data.customs)??[],findAllHighlightsOnPage:async e=>{const t=await Promise.all(e.capturedWebpage.highlights.map(n=>w.highlight.get(n)));Fa(t)},removeHighlightOnPage:async e=>{await Gs(e.highlightId)},checkUserHasTabsPermission:async e=>await ln(),askForTabsPermission:async e=>await sc(),askForAllUrlsAndTabsPermission:async e=>await za(),checkUserHasAllUrlsAndTabsPermission:async e=>await un(),turnOffSavedPageBadgeChecking:async e=>rc(),turnOnSavedPageBadgeChecking:async e=>Ha(),turnOnCaptureFloatingButtonWatcher:async e=>dn(),turnOffCaptureFloatingButtonWatcher:async(e,t)=>Ka(),showSavedBadgeIfPossible:async e=>oc(),turnOffClipperHeaderExpandButton:async(e,t)=>{await Ne(400),Pe("turnOffClipperHeaderExpandButton",t.tab.id)},openingQuickNoteIframe:async e=>(await J.set("iframeOpenMode","quickNote"),!0),clipContent:async(e,t)=>(Ks(e.action,e.props||null,t.tab.id),!0),quickCapture:async e=>{},openQuickCaptureFloatingButton:async(e,t)=>(Be("openQuickCaptureFloatingButton",void 0,t.tab.id),!0),closeQuickCaptureFloatingButton:async(e,t)=>(Be("closeQuickCaptureFloatingButton",void 0,t.tab.id),!0),openQuickCapturePopup:async(e,t)=>(Be("openQuickCapturePopup",void 0,t.tab.id),!0),closePopupQuickCapture:async(e,t)=>{Be("closePopupQuickCapture",void 0,t.tab.id)},saveQuickNoteFloatingButtonPosition:async e=>{const t=e.data.floatingPosition,n=await w.user.load();return await w.custom.saveUser({settings:{...n.settings,floatingQuickAddButtonOptions:{floatingPosition:t}}}),!0},getInitialFloatingButtonPosition:async e=>{var n;return((n=(await w.user.load()).settings.floatingQuickAddButtonOptions)==null?void 0:n.floatingPosition)||{left:"64px",bottom:"64px"}},action:async e=>{const t=e.fnName,n=e.props,{status:a,errorMsg:i,client:o}=await Xa();if(a=="error")throw new Error(`incorrect '${event.type}'`);const s={notionClient:new He({token:o.authToken,activeUserId:o.agent.activeUserId}),log:ne,db:w};return await Sa[t](n,s)}},Uc={loadInboxSDK:async(e,t)=>(await Ce("inboxSDK.js",t.tab),{success:!0}),getGmailMessageHistory:async(e,t)=>{const n=await Yr(`gmail-${e.data.messageId}`);return{success:n!=null,data:n}},clipGmailMessage:async(e,t)=>await gt(a=>chrome.permissions.request({origins:["https://mail.google.com/*"]},a))?{success:!0}:(alert(`you need to allow previous permission to save an email
Please try again
(no worry we won't read any of your emails 😊)`),{success:!1})},Oc={checkUserPaid:async()=>!1,getExtPayUser:async()=>{},openPaymentPage:async()=>!1},Ac={asyncExecTakeScreenshot:async(e,t)=>(await gt(n=>{chrome.tabs.captureVisibleTab(a=>{fe[e.asyncId]({success:a!=null,imageBase64:a}),n(!0)})}),{success:!0}),asyncSendScreenshot:async(e,t)=>(fe[e.asyncId]({...te(e,"asyncId")}),null),asyncExecTakeScreenshotGetImg:async(e,t)=>({success:!0,imageBase64:await gt(a=>chrome.tabs.captureVisibleTab(a))}),asyncExecPassScreenshot:async(e,t)=>(fe[e.asyncId]({success:e.imageBase64!=null,imageBase64:e.imageBase64,width:e.width,height:e.height}),null)},Mc=[Ec,Uc,Oc,Ac,zs];function jc(e){const t=Mc.find(n=>e in n);return t&&t[e]}async function Fc(e,t){var a,i;if(console.log("replyMessages",e,t,e.popup!=null),e.popup){if(console.log("send to popup",pt),pt.popupAsk){console.log("asking to popup..."),pt.popupAsk(e.popup.name,e.popup.args);return}return ne("send again",(a=t.tab)==null?void 0:a.id),chrome.tabs.sendMessage((i=t.tab)==null?void 0:i.id,{...e,fromBackground:!0}),null}const n=jc(e.type);return n?n(e,t):(ne("command not recognized:",e==null?void 0:e.type),null)}function aa(e,t){return new Promise(async n=>{e(await t()),n(!0)}),!0}function $c(e,t,n){var a;return e.v2?(console.log("event v2",e==null?void 0:e.event,e),e.destination!="background"?e.destination==="content"?(oe(e.event,e.props,(a=t.tab)==null?void 0:a.id).then(n),!0):void 0:aa(n,()=>{var i;return(i=V[e.event])==null?void 0:i.call(V,e.props,t)})):aa(i=>{console.log("bgEvent",e,"->",i),n(i)},()=>Fc(e,t))}async function Dc(e){if(e.name=="popupExchange"){V[e.name]({},e.sender,{onProgress:t=>{e.postMessage(t)}});return}if(e.name in V){e.onMessage.addListener(function(t){t.event=="payload"&&V[e.name](t.props,e.sender,{onProgress:n=>{e.postMessage({event:"progress",props:n})}}).then(n=>{e.postMessage({event:"done",props:n}),e.disconnect()}).catch(n=>{e.postMessage({event:"error",props:null}),e.disconnect()})});return}switch(e.name){case"get_metadatas":const t=await en();t?e.postMessage({type:"done",data:t}):e.postMessage({type:"error"}),e.disconnect();return}}const vt=ga?chrome.browserAction:chrome.action;let fe={};function Za(){chrome.contextMenus.create({title:"Save Page to Notion",id:"stn_save_page",contexts:["page"],documentUrlPatterns:["*://*/*"]}),!(ke||St)&&(chrome.contextMenus.create({title:"Take Full Page Screenshot",id:"stn_take_full_page_screenshot",contexts:["page"],documentUrlPatterns:["*://*/*"]}),chrome.contextMenus.create({title:"Select Zone to Screenshot",id:"stn_select_zone_screenshot",contexts:["page"],documentUrlPatterns:["*://*/*"]}))}async function Bc(){chrome.contextMenus.create({title:"Add Highlight",id:"stn_add_highlights",contexts:["selection"],documentUrlPatterns:["*://*/*"]}),Za(),vt.onClicked.addListener(Da),chrome.contextMenus.onClicked.addListener(nc),chrome.commands.onCommand.addListener(ac),chrome.runtime.onMessage.addListener($c),chrome.runtime.onInstalled.addListener(async e=>{w.info.save({installedAt:new Date().toISOString()})}),chrome.runtime.onConnect.addListener(Dc),ln().then(async e=>{e&&(await Ne(1e3),Ha())}),cc().then(async e=>{e&&dn()})}Bc();
